@page "/map"
@implements IAsyncDisposable
@using System.Collections.ObjectModel
@using Hurudza.UI.Web.Services
@using Microsoft.Extensions.Logging
@using IApiCall = Hurudza.UI.Web.Api.Interfaces.IApiCall
@inject FarmAccessService FarmAccessService
@attribute [Authorize]

@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject IApiCall ApiCall
@inject ILogger<Map> Logger
@inject NavigationManager Navigation

<HeadContent>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet"/>
    <!-- Add MapboxDraw CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.css" rel="stylesheet"/>
</HeadContent>

<style>
    .e-listview .e-list-item {
        color: black;
        background-color: white;
        min-height: 62px !important;
        height: auto !important;
        padding: 12px 16px !important;
    }

    .e-listview .e-list-item.e-focused {
        color: white;
        background-color: black;
    }

    /* Farm/School popup card styles */
    .farm-popup-card {
        min-width: 200px;
        max-width: 300px;
    }

    .farm-popup-card .popup-header {
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }

    .farm-popup-card .popup-header h6 {
        color: #333;
        font-weight: 600;
        margin: 0;
    }

    .farm-popup-card .popup-body {
        padding: 4px 0;
    }

    .farm-popup-card .popup-footer {
        padding-top: 8px;
        border-top: 1px solid #eee;
    }

    .farm-popup-card .btn {
        font-size: 12px;
        padding: 6px 12px;
    }

    #container .e-listview {
        box-shadow: 0 1px 4px #ddd;
        border-bottom: 1px solid #ddd;
    }

    .sample {
        justify-content: center;
        min-height: 280px;
    }

    .vertical-center {
        align-items: center;
    }

    .padding {
        padding: 4px;
    }

    .flex {
        display: flex;
    }

    .flex__center {
        justify-content: center;
    }

    .margin {
        margin: 10px;
    }

    #map {
        width: 100%;
        height: 100%;
        min-height: 100vh;
    }

    .sidebar-container {
        width: 40%;
        padding: 8px;
        max-height: 100vh;
        overflow-y: auto;
        transition: all 0.3s ease;
        background-color: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* Style fix for list items to prevent text truncation */
    .e-listview .e-list-item .e-list-content {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow: visible !important;
        line-height: 1.4 !important;
    }

    /* Ensure all list items have proper padding and spacing */
    .list-group-item {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Make headers more prominent */
    .e-listview .e-list-item .e-list-item-header {
        font-weight: 500 !important;
        margin-bottom: 4px !important;
        font-size: 14px !important;
    }

    /* Ensure proper spacing between items */
    .e-listview .e-list-item + .e-list-item {
        margin-top: 4px !important;
    }

    .sidebar-header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .search-box {
        margin-bottom: 10px;
    }

    .list-container {
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .panel-hidden {
        display: none;
    }

    /* Field list styles */
    .field-list {
        margin-top: 1rem;
        border-top: 1px solid #e9ecef;
        padding-top: 1rem;
    }

    .field-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        transition: all 0.2s ease;
    }

    .field-item:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    /* Add to your site CSS or component styles */
    .custom-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }

    .custom-marker:hover {
        transform: scale(1.1);
    }

    .temp-marker {
        animation: pulse 1.5s infinite;
    }

    @@keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
        }
    }

    /* Mapbox popup styling for farms */
    .mapboxgl-popup-content h6 {
        margin: 0 0 5px 0;
        font-weight: bold;
    }

    .mapboxgl-popup-content p {
        margin: 0;
        font-size: 12px;
        color: #666;
    }
</style>

<Toast @ref="_alert"/>

<div style="height:100%;width:100%;display:flex;flex-direction:row">
    <!-- Schools List Panel -->
    <div class="sidebar-container @_showSchools">
        <div class="sidebar-header">
            <div>
                <h3>Farms & Schools</h3>
            </div>
            <div>
                <button class="btn bg-white btn-icon-only me-2" @onclick="ToggleFiltersModal" title="Filter Farms & Schools">
                    <i class="fa fa-filter"></i>
                </button>
                <button class="btn bg-white btn-icon-only" @onclick="ToggleSchools">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="search-box input-group">
            <input type="text" class="form-control" placeholder="Search farms & schools..." @bind-value="_searchTerm"
                   @bind-value:event="oninput" @onkeyup="FilterFarms">
            @if (!string.IsNullOrEmpty(_searchTerm))
            {
                <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                    <i class="fa fa-times"></i>
                </button>
            }
        </div>
        <div class="list-container my-2">
            @if (_loading)
            {
                <div class="text-center py-4">
                    <SfSpinner></SfSpinner>
                    <p class="mt-2">Loading schools...</p>
                </div>
            }
            else if (_filteredFarms == null || !_filteredFarms.Any())
            {
                <div class="text-center py-4">
                    <p>No schools found.</p>
                </div>
            }
            else
            {
                <SfListView DataSource="@_filteredFarms" Height="calc(100vh - 150px)">
                    <ListViewFieldSettings TValue="FarmViewModel" Id="Id" Text="Name"></ListViewFieldSettings>
                    <ListViewTemplates TValue="FarmViewModel">
                        <Template>
                            @{
                                FarmViewModel farm = (FarmViewModel)context;
                                <div class="e-list-wrapper e-list-multi-line" @onclick="(e => OnFarmSelect(farm))">
                                    <div class="e-list-item-header text-truncate">@farm.Name</div>
                                    <div class="e-list-content"
                                         style="white-space: normal; font-size: 13px; padding-top: 4px;">
                                        <div class="d-flex flex-wrap">
                                            @if (farm.Size > 0)
                                            {
                                                <span class="me-2 mb-1 badge bg-light text-dark">@farm.Size ha</span>
                                            }
                                            @if (farm.Conference.HasValue)
                                            {
                                                <span class="me-2 mb-1 badge bg-info text-white">@farm.Conference</span>
                                            }
                                            @if (!string.IsNullOrEmpty(farm.Province))
                                            {
                                                <span class="mb-1 badge bg-secondary text-white">@farm.Province</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(farm.Address))
                                        {
                                            <div
                                                class="text-muted mt-1 small">@(farm.Address.Length > 50 ? farm.Address.Substring(0, 50) + "..." : farm.Address)</div>
                                        }
                                    </div>
                                </div>}
                        </Template>
                    </ListViewTemplates>
                </SfListView>
            }
        </div>
    </div>

    <!-- School Details Panel with Integrated Fields List -->
    <div class="sidebar-container @_showSchoolDetails">
        <div class="card h-100">
            <div class="card-header pb-0 p-3">
                <div class="row">
                    <div class="col-md-1 text-start">
                        <a href="javascript:;" @onclick="GoBackToList">
                            <i class="fas fa-arrow-left text-secondary text-sm" data-bs-toggle="tooltip"
                               data-bs-placement="top" aria-hidden="true" aria-label="Go Back"
                               data-bs-original-title="Go Back"></i><span class="sr-only">Go Back</span>
                        </a>
                    </div>
                    <div class="col-md-7 d-flex align-items-center">
                        <h6 class="mb-0">@(_farm?.FarmType == FarmType.School ? "School Details" : "Farm Details")</h6>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="javascript:;" @onclick="ShowEdit">
                            <i class="fas fa-user-edit text-secondary text-sm" data-bs-toggle="tooltip"
                               data-bs-placement="top" aria-hidden="true" aria-label="Edit Profile"
                               data-bs-original-title="Edit Profile"></i><span class="sr-only">Edit Profile</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                @if (_farm != null)
                {
                    <h5 class="mb-0">@_farm.Name</h5>
                    <p class="text-sm">
                        @_farm.Description
                    </p>
                    <hr class="horizontal gray-light my-4">
                    @*<ul class="list-group">
                        <li class="list-group-item border-0 ps-0 pt-0 text-sm">
                            <strong class="text-dark">Address:</strong>
                            <div style="word-wrap: break-word;">@_farm.Address</div>
                        </li>
                        <li class="list-group-item border-0 ps-0 pt-0 text-sm"><strong class="text-dark">Primary
                                Contact:</strong> &nbsp; @_farm.ContactPerson</li>
                        <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Mobile:</strong>
                            &nbsp; @_farm.PhoneNumber</li>
                        <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Email:</strong>
                            &nbsp; @_farm.Email</li>
                        <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Website:</strong>
                            &nbsp; @_farm.Website</li>
                    </ul>*@
                    <hr class="horizontal gray-light my-2">

                <!-- Fields Section - Integrated directly into school details -->
                <div class="field-list">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Fields</h6>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" @onclick="ShowUploadFields">
                                <i class="fas fa-upload me-1"></i> Upload KML
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="ShowEditField">
                                <i class="fas fa-plus me-1"></i> Add Field
                            </button>
                        </div>
                    </div>

                    @if (_fieldsLoading)
                    {
                        <div class="text-center py-2">
                            <SfSpinner></SfSpinner>
                            <p class="mt-2">Loading fields...</p>
                        </div>
                    }
                    else if (_fields == null || !_fields.Any())
                    {
                        <div class="alert alert-info text-center">
                            <p>No fields have been added to this school.</p>
                            <button class="btn btn-sm btn-success mt-2" @onclick="ShowEditField">Add Field</button>
                        </div>
                    }
                    else
                    {
                        <div class="field-list-container">
                            @foreach (var field in _fields)
                            {
                                <div class="field-item" @onclick="() => OnFieldSelect(field)"
                                     @onmouseover="() => HighlightField(field)"
                                     @onmouseout="() => UnhighlightField(field)">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="mb-0">@field.Name</h6>
                                        <div>
                                            <span class="badge bg-light text-dark me-1">@field.Size ha</span>
                                            <span class="badge @(field.Irrigation ? "bg-success" : "bg-secondary")">
                                                @(field.Irrigation ? "Irrigated" : "Non-irrigated")
                                            </span>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(field.Description))
                                    {
                                        <p class="text-muted small mb-0">@(field.Description.Length > 100 ? field.Description.Substring(0, 100) + "..." : field.Description)</p>
                                    }
                                    <div class="mt-2">
                                        <small class="text-muted">Soil Type: @field.SoilType</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                
                @if (_farm?.FarmType == FarmType.School && _user != null && (_user.IsInRole(ApiRoles.Administrator) || _user.IsInRole(ApiRoles.FarmAdministrator)))
                {
                    <div class="school-admin-section mt-4">
                        <h5>Managed Farms (@_managedFarms.Count)</h5>
                        <button class="btn btn-primary btn-sm" @onclick="ShowAddFarmForm">
                            <i class="fas fa-plus"></i> Add New Farm
                        </button>
        
                        @if (_managedFarms.Any())
                        {
                            <div class="managed-farms-list mt-3">
                                @foreach (var managedFarm in _managedFarms)
                                {
                                    <div class="farm-item border rounded p-2 mb-2">
                                        <h6>@managedFarm.Name</h6>
                                        <p class="mb-1">Size: @managedFarm.Size ha | Arable: @managedFarm.Arable ha</p>
                                        <p class="mb-1">Tillage Required: @(managedFarm.RequiresTillageService ? "Yes" : "No")</p>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                @onclick="() => ViewFarmDetails(managedFarm)">
                                            View Details
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                }
            </div>
        </div>
    </div>

    <!-- Field Details Panel -->
    <div class="sidebar-container @_showFieldDetails">
        <div class="card h-100">
            <div class="card-header pb-0 p-3">
                <div class="row">
                    <div class="col-md-1 text-start">
                        <a href="javascript:;" @onclick="GoBackToSchool">
                            <i class="fas fa-arrow-left text-secondary text-sm" data-bs-toggle="tooltip"
                               data-bs-placement="top" aria-hidden="true" aria-label="Go Back"
                               data-bs-original-title="Go Back"></i><span class="sr-only">Go Back</span>
                        </a>
                    </div>
                    <div class="col-md-7 d-flex align-items-center">
                        <h6 class="mb-0">Field Details</h6>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="javascript:;" @onclick="EditCurrentField">
                            <i class="fas fa-edit text-secondary text-sm" data-bs-toggle="tooltip"
                               data-bs-placement="top" aria-hidden="true" aria-label="Edit Field"
                               data-bs-original-title="Edit Field"></i><span class="sr-only">Edit Field</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                @if (_field != null)
                {
                    <h5 class="mb-0">@_field.Name</h5>
                <hr class="horizontal gray-light my-4">
                <ul class="list-group">
                    <li class="list-group-item border-0 ps-0 pt-0 text-sm">
                        <strong class="text-dark">Description:</strong> &nbsp; @_field.Description
                    </li>
                    <li class="list-group-item border-0 ps-0 pt-0 text-sm">
                        <strong class="text-dark">Size:</strong> &nbsp; @_field.Size ha
                    </li>
                    <li class="list-group-item border-0 ps-0 text-sm">
                        <strong class="text-dark">Soil Type:</strong> &nbsp; @_field.SoilType.ToString()
                    </li>
                    <li class="list-group-item border-0 ps-0 text-sm">
                        <strong class="text-dark">Irrigation:</strong> &nbsp; @(_field.Irrigation ? "Yes" : "No")
                    </li>
                </ul>

                <div class="col-12 text-center mt-3 mb-3">
                    <a class="btn btn-sm btn-success me-2" href="/field/@_field.Id/crops">Manage Crops</a>
                    <button class="btn btn-sm btn-primary" @onclick="AddCoordinate">Add Coordinate</button>
                </div>

                @if (!string.IsNullOrEmpty(_currentCrop))
                {
                    <div class="alert alert-info">
                        <strong>Current Crop:</strong> @_currentCrop
                    </div>
                }

                <SfAccordion>
                    <AccordionItems>
                        <AccordionItem Expanded="true">
                            <HeaderTemplate>
                                <div class="col-md-12 d-flex align-items-center">
                                    <h6 class="mb-0">Coordinates (@_fieldLocations.Count)</h6>
                                </div>
                            </HeaderTemplate>
                            <ContentTemplate>
                                @if (_fieldLocations == null || !_fieldLocations.Any())
                                {
                                    <div class="text-center py-3">
                                        <p>No coordinates defined for this field.</p>
                                        <button class="btn btn-sm btn-success" @onclick="AddCoordinate">Add Coordinate
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="list-container" style="max-height: 200px; overflow-y: auto;">
                                        <SfListView DataSource="@_fieldLocations">
                                            <ListViewFieldSettings TValue="FieldLocationViewModel" Id="Id"
                                                                   Text="Text"></ListViewFieldSettings>
                                            <ListViewTemplates TValue="FieldLocationViewModel">
                                                <Template>
                                                    @{
                                                        FieldLocationViewModel coordinate = (FieldLocationViewModel)context;
                                                        <div class="e-list-wrapper e-list-multi-line"
                                                             @onclick="(e => OnCoordinateSelect(coordinate))">
                                                            <div class="e-list-item-header">
                                                                @(string.IsNullOrEmpty(coordinate.Label) ? "Point" : coordinate.Label)
                                                            </div>
                                                            <div class="e-list-content text-muted">
                                                                <small>@coordinate.Latitude, @coordinate.Longitude</small>
                                                            </div>
                                                        </div>
                                                    }
                                                </Template>
                                            </ListViewTemplates>
                                        </SfListView>
                                    </div>
                                }

                                @if (_showCoordinateForm)
                                {
                                    <hr class="horizontal gray-light my-3">
                                    <h6 class="mb-3">@(_editingCoordinate ? "Edit Coordinate" : "Add Coordinate")</h6>

                                    <EditForm Model="@_fieldLocation" OnValidSubmit="@SaveFieldLocation">
                                        <DataAnnotationsValidator/>
                                        <ValidationSummary/>

                                        <SfTextBox ID="id" TValue="string" hidden="hidden"
                                                   @bind-Value="@(_fieldLocation.Id)"></SfTextBox>

                                        <div class="form-group mb-3">
                                            <label>Label (Optional)</label>
                                            <SfTextBox ID="label" TValue="string" @bind-Value="@(_fieldLocation.Label)"
                                                       Placeholder="Point Name (optional)"></SfTextBox>
                                        </div>

                                        <div class="form-group mb-3">
                                            <label>Latitude</label>
                                            <SfNumericTextBox ID="latitude" TValue="double"
                                                              @bind-Value="@(_fieldLocation.Latitude)"
                                                              Decimals=7 Format="n7"
                                                              Placeholder="e.g. -17.8248"></SfNumericTextBox>
                                        </div>

                                        <div class="form-group mb-3">
                                            <label>Longitude</label>
                                            <SfNumericTextBox ID="longitude" TValue="double"
                                                              @bind-Value="@(_fieldLocation.Longitude)"
                                                              Decimals=7 Format="n7"
                                                              Placeholder="e.g. 31.0530"></SfNumericTextBox>
                                        </div>

                                        <div class="form-group mb-3">
                                            <label>Altitude (meters)</label>
                                            <SfNumericTextBox ID="altitude" TValue="double"
                                                              @bind-Value="@(_fieldLocation.Altitude)"
                                                              Decimals=2 Format="n2"
                                                              Placeholder="e.g. 1200"></SfNumericTextBox>
                                        </div>

                                        <div class="form-group d-flex justify-content-between">
                                            <button type="submit" class="btn btn-success">
                                                @(_editingCoordinate ? "Update" : "Add")
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                    @onclick="CancelCoordinateEdit">
                                                Cancel
                                            </button>
                                        </div>
                                    </EditForm>
                                }
                            </ContentTemplate>
                        </AccordionItem>
                    </AccordionItems>
                </SfAccordion>
                }
            </div>
        </div>
    </div>

    <!-- Add/Edit Farm Panel -->
    <div class="sidebar-container @_showAddSchool">
        <div class="sidebar-header">
            <div>
                @if (_farm == null || string.IsNullOrEmpty(_farm.Id))
                {
                    <h5>Add New School</h5>
                }
                else
                {
                    <h5>@(_farm?.FarmType == FarmType.School ? "Edit School" : "Edit Farm")</h5>
                }
            </div>
            <button class="btn bg-white btn-icon-only" @onclick="CancelEdit">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <div class="my-2">
            @if (_farm != null)
            {
                <EditForm Model="@_farm" OnValidSubmit="@SaveFarm">
                <DataAnnotationsValidator/>
                <ValidationSummary/>

                <!-- Form content with many fields, abbreviated for readability -->
                <SfTextBox ID="id" TValue="string" hidden="hidden" @bind-Value="@(_farm.Id)"></SfTextBox>

                <div class="form-group mb-3">
                    <label>Name *</label>
                    <SfTextBox ID="name" TValue="string" @bind-Value="@(_farm.Name)"
                               Placeholder="School name" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _farm.Name"/>
                </div>

                <div class="form-group mb-3">
                    <label>Address *</label>
                    <SfTextBox ID="address" TValue="string" @bind-Value="@(_farm.Address)"
                               Placeholder="Physical address" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _farm.Address"/>
                </div>

                <!-- Only showing a few key fields for brevity, the actual form has many more -->
                <div class="form-group mb-3">
                    <label>Contact Person</label>
                    <SfTextBox ID="contactPerson" TValue="string" @bind-Value="@(_farm.ContactPerson)"
                               Placeholder="e.g. John Doe"></SfTextBox>
                </div>

                <div class="form-group mb-3">
                    <label>Phone Number *</label>
                    <SfTextBox ID="phone" TValue="string" @bind-Value="@(_farm.PhoneNumber)"
                               Placeholder="e.g. 0771234567" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _farm.PhoneNumber"/>
                </div>

                <div class="form-group mb-3">
                    <label>Email *</label>
                    <SfTextBox ID="email" TValue="string" @bind-Value="@(_farm.Email)"
                               Placeholder="e.g. school@example.com" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _farm.Email"/>
                </div>

                <!-- Location fields -->
                <div class="form-group mb-3">
                    <label>Latitude</label>
                    <SfNumericTextBox ID="latitude" TValue="double" @bind-Value="@(_farm.Latitude)"
                                      Decimals=7 Format="n7" Placeholder="e.g. -17.8248"></SfNumericTextBox>
                </div>

                <div class="form-group mb-3">
                    <label>Longitude</label>
                    <SfNumericTextBox ID="longitude" TValue="double" @bind-Value="@(_farm.Longitude)"
                                      Decimals=7 Format="n7" Placeholder="e.g. 31.0530"></SfNumericTextBox>
                </div>

                <div class="form-group mb-3">
                    <p class="text-muted">
                        Current Location: @(_farm.Latitude == 0 && _farm.Longitude == 0 ? "Not set" : $"{_farm.Latitude:F6}, {_farm.Longitude:F6}")
                    </p>
                    <button type="button" class="btn btn-secondary btn-sm" 
                            @onclick="EnableMapClickForEditLocation">
                        Set Location on Map
                    </button>
                </div>

                <!-- Farm/School boundary drawing instructions -->
                <div class="alert alert-primary mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-draw-polygon me-2"></i>
                        <div>
                            <strong>Draw @(_farm.FarmType == Hurudza.Data.Enums.Enums.FarmType.School ? "School" : "Farm") Boundary</strong>
                            <p class="mb-0">Use the draw tool <i class="fa fa-draw-polygon"></i> in the top-right corner
                                of the map to draw the @(_farm.FarmType == Hurudza.Data.Enums.Enums.FarmType.School ? "school" : "farm") boundary.</p>
                            <div class="mt-1 small">
                                <p class="mb-0"><i class="fa fa-info-circle me-1"></i> The area will be
                                    automatically calculated from the boundary.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boundary status -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>@(_farm.FarmType == Hurudza.Data.Enums.Enums.FarmType.School ? "School" : "Farm") Boundary:</span>
                        @if (_drawnSchoolCoordinates != null && _drawnSchoolCoordinates.Count > 0)
                        {
                            <span class="badge bg-success">
                                <i class="fa fa-check me-1"></i> Drawn (@_drawnSchoolCoordinates.Count points)
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-warning">
                                <i class="fa fa-exclamation-triangle me-1"></i> Not Drawn
                            </span>
                        }
                    </div>
                </div>

                <!-- Other form fields would go here -->

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-lg bg-gradient-success w-100 mb-3">Save</button>
                    <button type="button" class="btn btn-lg bg-gradient-secondary w-100" @onclick="CancelEdit">Cancel
                    </button>
                </div>
            </EditForm>
            }
        </div>
    </div>

    <!-- Add/Edit Field Panel -->
    <div class="sidebar-container @_showFieldEdit">
        <div class="sidebar-header">
            <div>
                @if (_fieldEdit == null || string.IsNullOrEmpty(_fieldEdit.Id))
                {
                    <h5>Add New Field</h5>
                }
                else
                {
                    <h5>Edit Field</h5>
                }
            </div>
            <button class="btn bg-white btn-icon-only" @onclick="CancelFieldEdit">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <div class="my-2">
            <EditForm Model="@_fieldEdit" OnValidSubmit="@SaveField">
                <DataAnnotationsValidator/>
                <ValidationSummary/>

                <SfTextBox ID="fieldId" TValue="string" hidden="hidden" @bind-Value="@(_fieldEdit.Id)"></SfTextBox>
                <SfTextBox ID="farmId" TValue="string" hidden="hidden" @bind-Value="@(_fieldEdit.FarmId)"></SfTextBox>

                <div class="form-group mb-3">
                    <label>Name *</label>
                    <SfTextBox ID="fieldName" TValue="string" @bind-Value="@(_fieldEdit.Name)"
                               Placeholder="Field name" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _fieldEdit.Name"/>
                </div>

                <div class="form-group mb-3">
                    <label>Description</label>
                    <SfTextBox Multiline="true" ID="fieldDescription" TValue="string"
                               @bind-Value="@(_fieldEdit.Description)"
                               Placeholder="Field description"></SfTextBox>
                </div>

                <div class="form-group mb-3">
                    <label>Size (Hectares) *</label>
                    <div class="d-flex align-items-center">
                        <SfNumericTextBox ID="fieldSize" TValue="float" @bind-Value="@(_fieldEdit.Size)" Decimals=2
                                          Format="n2" Placeholder="e.g. 5.75" CssClass="me-2"></SfNumericTextBox>
                        @if (_drawnCoordinates != null && _drawnCoordinates.Count > 0)
                        {
                            <span class="badge bg-success">
                            <i class="fa fa-calculator me-1"></i> Auto-calculated
                        </span>
                        }
                    </div>
                    <ValidationMessage For="() => _fieldEdit.Size"/>
                    <small class="text-muted">Draw the field boundary to auto-calculate the area</small>
                </div>

                <div class="form-group mb-3">
                    <label>Soil Type</label>
                    <SfDropDownList ID="soilType" TValue="SoilType" TItem="SoilTypeModel"
                                    @bind-Value="@(_fieldEdit.SoilType)" PopupHeight="350px" PopupWidth="350px"
                                    Placeholder="Select Soil Type" DataSource="@_soilTypes">
                        <DropDownListFieldSettings Value="SoilType" Text="Name"></DropDownListFieldSettings>
                    </SfDropDownList>
                </div>

                <div class="form-group mb-3">
                    <SfCheckBox Label="Under Irrigation" @bind-Checked="@(_fieldEdit.Irrigation)"></SfCheckBox>
                </div>

                <!-- Field boundary drawing instructions with Turf.js details -->
                <div class="alert alert-dark text-white mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-draw-polygon me-2 text-white"></i>
                        <div>
                            <strong>Draw Field Boundary</strong>
                            <p class="mb-0">Use the draw tool <i class="fa fa-draw-polygon text-white"></i> in the
                                top-right corner
                                of the map to draw the field boundary.</p>
                            <div class="mt-1 small">
                                <p class="mb-0"><i class="fa fa-info-circle me-1"></i> The field size will be
                                    automatically calculated using Turf.js geospatial analysis.</p>
                                <p class="mb-0"><i class="fa fa-check-circle me-1 text-success"></i> This provides
                                    precise area measurements accounting for Earth's curvature.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add a section to show coordinates status -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Field Boundary:</span>
                        @if (_drawnCoordinates != null && _drawnCoordinates.Count > 0)
                        {
                            <span class="badge bg-success">
                            <i class="fa fa-check me-1"></i> Drawn (@_drawnCoordinates.Count points)
                        </span>
                        }
                        else
                        {
                            <span class="badge bg-warning">
                            <i class="fa fa-exclamation-triangle me-1"></i> Not Drawn
                        </span>
                        }
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-lg bg-gradient-success w-100 mb-3">Save</button>
                    <button type="button" class="btn btn-lg bg-gradient-secondary w-100" @onclick="CancelFieldEdit">
                        Cancel
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Add New Farm Panel -->
    <div class="sidebar-container @_showAddFarm">
        <div class="sidebar-header">
            <div>
                <h5>Add New Farm</h5>
            </div>
            <button class="btn bg-white btn-icon-only" @onclick="CancelAddFarm">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <div class="my-2">
            <EditForm Model="@_newFarm" OnValidSubmit="@SaveNewFarm">
                <DataAnnotationsValidator/>
                <ValidationSummary/>

                <div class="form-group mb-3">
                    <label>Farm Name *</label>
                    <SfTextBox @bind-Value="_newFarm.Name" Placeholder="Enter farm name" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _newFarm.Name"/>
                </div>
                
                <div class="form-group mb-3">
                    <label>Address</label>
                    <SfTextBox @bind-Value="_newFarm.Address" Placeholder="Enter address" Multiline="true"></SfTextBox>
                </div>
                
                <div class="form-group mb-3">
                    <label>Contact Person *</label>
                    <SfTextBox @bind-Value="_newFarm.ContactPerson" Placeholder="Enter contact person" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _newFarm.ContactPerson"/>
                </div>
                
                <div class="form-group mb-3">
                    <label>Phone Number *</label>
                    <SfTextBox @bind-Value="_newFarm.PhoneNumber" Placeholder="Enter phone number" ValidateOnInput="true"></SfTextBox>
                    <ValidationMessage For="() => _newFarm.PhoneNumber"/>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Size (ha)</label>
                            <SfNumericTextBox @bind-Value="_newFarm.Size" Placeholder="Enter size" Format="N2"></SfNumericTextBox>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Arable Land (ha)</label>
                            <SfNumericTextBox @bind-Value="_newFarm.Arable" Placeholder="Enter arable land" Format="N2"></SfNumericTextBox>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <SfCheckBox @bind-Checked="_newFarm.RequiresTillageService" Label="Requires Tillage Service"></SfCheckBox>
                </div>
                
                @if (_newFarm.RequiresTillageService)
                {
                    <div class="form-group mb-3">
                        <label>Tillage Requirements</label>
                        <SfTextBox @bind-Value="_newFarm.TillageRequirements" Placeholder="Enter tillage requirements" Multiline="true"></SfTextBox>
                    </div>
                }

                <!-- Location fields -->
                <div class="form-group mb-3">
                    <label>Latitude</label>
                    <SfNumericTextBox ID="newFarmLatitude" TValue="double" @bind-Value="@_newFarm.Latitude"
                                      Decimals=7 Format="n7" Placeholder="e.g. -17.8248"></SfNumericTextBox>
                </div>

                <div class="form-group mb-3">
                    <label>Longitude</label>
                    <SfNumericTextBox ID="newFarmLongitude" TValue="double" @bind-Value="@_newFarm.Longitude"
                                      Decimals=7 Format="n7" Placeholder="e.g. 31.0530"></SfNumericTextBox>
                </div>

                <div class="form-group mb-3">
                    <p class="text-muted">
                        Current Location: @(_newFarm.Latitude == 0 && _newFarm.Longitude == 0 ? "Not set" : $"{_newFarm.Latitude:F6}, {_newFarm.Longitude:F6}")
                    </p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary btn-sm" 
                                @onclick="EnableMapClickForNewFarmLocation">
                            Set Location on Map
                        </button>
                        @if (_newFarm.Latitude != 0 || _newFarm.Longitude != 0)
                        {
                            <button type="button" class="btn btn-danger btn-sm" 
                                    @onclick="ClearNewFarmLocation">
                                <i class="fas fa-trash-alt"></i> Clear Location
                            </button>
                        }
                    </div>
                </div>

                <!-- Farm boundary drawing instructions -->
                <div class="alert alert-primary mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-draw-polygon me-2"></i>
                        <div>
                            <strong>Draw Farm Boundary</strong>
                            <p class="mb-0">Use the draw tool <i class="fa fa-draw-polygon"></i> in the top-right corner
                                of the map to draw the farm boundary.</p>
                            <div class="mt-1 small">
                                <p class="mb-0"><i class="fa fa-info-circle me-1"></i> The farm size will be
                                    automatically calculated from the boundary area.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Farm boundary status -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Farm Boundary:</span>
                        @if (_drawnFarmCoordinates != null && _drawnFarmCoordinates.Count > 0)
                        {
                            <span class="badge bg-success">
                                <i class="fa fa-check me-1"></i> Drawn (@_drawnFarmCoordinates.Count points)
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-warning">
                                <i class="fa fa-exclamation-triangle me-1"></i> Not Drawn
                            </span>
                        }
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-lg bg-gradient-success w-100 mb-3">Save</button>
                    <button type="button" class="btn btn-lg bg-gradient-secondary w-100" @onclick="CancelAddFarm">
                        Cancel
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Main Map Container -->
    <div id="map" @ref="_mapElement" style="width:100%" class="min-height-vh-100"></div>

    <!-- Dialogs -->
    <SfDialog Width="300px" ShowCloseIcon="true" IsModal="true" @bind-Visible="@_showDeleteCoordinateDialog">
        <DialogTemplates>
            <Header>Delete Coordinate</Header>
            <Content>
                <p>Are you sure you want to delete this coordinate?</p>
                @if (!string.IsNullOrEmpty(_fieldLocation.Label))
                {
                    <p><strong>@_fieldLocation.Label</strong></p>
                }
                <p>Coordinates: @_fieldLocation.Latitude, @_fieldLocation.Longitude</p>
            </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton Content="Delete" OnClick="@DeleteFieldCoordinate" CssClass="e-danger"/>
            <DialogButton Content="Cancel" IsPrimary="true" OnClick="@CancelDeleteCoordinate"/>
        </DialogButtons>
    </SfDialog>

    <SfDialog Width="400px" ShowCloseIcon="true" IsModal="true" @bind-Visible="@_showUploadFieldsDialog">
        <DialogTemplates>
            <Header>Upload KML File</Header>
            <Content>
                <p class="mb-3">Upload a KML file to import field boundaries.</p>

                <EditForm Model="_kml" OnValidSubmit="@SaveKmlFile">
                    <div class="form-group mb-3">
                        <label>Select KML File</label>
                        <InputFile OnChange="LoadKmlFiles" class="form-control" accept=".kml"/>

                        @if (_loadedKmlFile != null)
                        {
                            <div class="alert alert-info mt-2">
                                Selected file: @_loadedKmlFile.Name (@(_loadedKmlFile.Size / 1024) KB)
                            </div>
                        }
                    </div>

                    <div class="form-group">
                        @if (_loadingKml)
                        {
                            <SfSpinner></SfSpinner>
                            <p class="text-center mt-2">Processing...</p>
                        }
                    </div>

                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-success"
                                disabled="@(_loadedKmlFile == null || _loadingKml)">Upload
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" @onclick="CloseKmlUploadDialog">Cancel
                        </button>
                    </div>
                </EditForm>
            </Content>
        </DialogTemplates>
    </SfDialog>

    <!-- Filters Modal -->
    <SfDialog Width="500px" Height="600px" IsModal="true" ShowCloseIcon="true" @bind-Visible="@ShowFiltersModal">
        <DialogTemplates>
            <Header>Filter Farms & Schools</Header>
            <Content>
                <div class="container">
                    <EditForm Model="@_filterModel" OnValidSubmit="@ApplyFilters">
                        <!-- Province Filter -->
                        <div class="form-group mb-3">
                            <label>Province</label>
                            <SfDropDownList TValue="string" TItem="ProvinceViewModel"
                                            @bind-Value="@_filterModel.ProvinceId"
                                            DataSource="@_provinces"
                                            AllowFiltering="true"
                                            Placeholder="Select Province"
                                            FilterBarPlaceholder="Search province...">
                                <DropDownListFieldSettings Value="Id" Text="Name"></DropDownListFieldSettings>
                                <DropDownListEvents TValue="string" TItem="ProvinceViewModel"
                                                    ValueChange="ProvinceChangeHandler"></DropDownListEvents>
                            </SfDropDownList>
                        </div>

                        <!-- Region Filter -->
                        <div class="form-group mb-3">
                            <label>Region</label>
                            <SfDropDownList TValue="Region?" TItem="RegionModel"
                                            @bind-Value="@_filterModel.Region"
                                            DataSource="@_regions"
                                            AllowFiltering="true"
                                            Placeholder="Select Region">
                                <DropDownListFieldSettings Value="Region" Text="Name"></DropDownListFieldSettings>
                            </SfDropDownList>
                        </div>

                        <!-- Conference Filter -->
                        <div class="form-group mb-3">
                            <label>Conference</label>
                            <SfDropDownList TValue="Conference?" TItem="ConferenceModel"
                                            @bind-Value="@_filterModel.Conference"
                                            DataSource="@_conferences"
                                            AllowFiltering="true"
                                            Placeholder="Select Conference">
                                <DropDownListFieldSettings Value="Conference" Text="Name"></DropDownListFieldSettings>
                            </SfDropDownList>
                        </div>

                        <!-- Farm Type Filter -->
                        <div class="form-group mb-3">
                            <label>Type</label>
                            <SfDropDownList TValue="FarmType?" TItem="FarmTypeModel"
                                            @bind-Value="@_filterModel.FarmType"
                                            DataSource="@_farmTypes"
                                            AllowFiltering="false"
                                            Placeholder="All Types">
                                <DropDownListFieldSettings Value="Value" Text="Text"></DropDownListFieldSettings>
                            </SfDropDownList>
                        </div>

                        <!-- Farm Size Range -->
                        <div class="form-group mb-3">
                            <label>Farm Size (hectares)</label>
                            <div class="d-flex align-items-center gap-2">
                                <SfNumericTextBox TValue="float?" @bind-Value="@_filterModel.MinSize"
                                                  Placeholder="Min Size"
                                                  Min="0"
                                                  Format="n1"
                                                  Step="1"
                                                  ShowSpinButton="false">
                                </SfNumericTextBox>
                                <span>to</span>
                                <SfNumericTextBox TValue="float?" @bind-Value="@_filterModel.MaxSize"
                                                  Placeholder="Max Size"
                                                  Min="0"
                                                  Format="n1"
                                                  Step="1"
                                                  ShowSpinButton="false">
                                </SfNumericTextBox>
                            </div>
                        </div>

                        <!-- District Filter (dependent on Province) -->
                        <div class="form-group mb-3">
                            <label>District</label>
                            <SfDropDownList TValue="string" TItem="DistrictViewModel"
                                            @bind-Value="@_filterModel.DistrictId"
                                            DataSource="@_districts"
                                            AllowFiltering="true"
                                            Enabled="@(!string.IsNullOrEmpty(_filterModel.ProvinceId))"
                                            Placeholder="@(string.IsNullOrEmpty(_filterModel.ProvinceId) ? "Select Province first" : "Select District")">
                                <DropDownListFieldSettings Value="Id" Text="Name"></DropDownListFieldSettings>
                                <DropDownListEvents TValue="string" TItem="DistrictViewModel"
                                                    ValueChange="DistrictChangeHandler"></DropDownListEvents>
                            </SfDropDownList>
                        </div>

                        <!-- Local Authority Filter (dependent on District) -->
                        <div class="form-group mb-3">
                            <label>Local Authority</label>
                            <SfDropDownList TValue="string" TItem="LocalAuthorityViewModel"
                                            @bind-Value="@_filterModel.LocalAuthorityId"
                                            DataSource="@_localAuthorities"
                                            AllowFiltering="true"
                                            Enabled="@(!string.IsNullOrEmpty(_filterModel.DistrictId))"
                                            Placeholder="@(string.IsNullOrEmpty(_filterModel.DistrictId) ? "Select District first" : "Select Local Authority")">
                                <DropDownListFieldSettings Value="Id" Text="Name"></DropDownListFieldSettings>
                            </SfDropDownList>
                        </div>

                        <!-- Applied Filters Display -->
                        @if (HasActiveFilters())
                        {
                            <div class="alert alert-info mt-4">
                                <strong>Active Filters:</strong>
                                <ul class="mb-0 mt-1">
                                    @if (!string.IsNullOrEmpty(_filterModel.ProvinceId))
                                    {
                                        var province = _provinces.FirstOrDefault(p => p.Id == _filterModel.ProvinceId)?.Name ?? "Unknown";
                                        <li>Province: @province</li>
                                    }
                                    @if (_filterModel.Region.HasValue)
                                    {
                                        <li>Region: @_filterModel.Region.Value</li>
                                    }
                                    @if (_filterModel.Conference.HasValue)
                                    {
                                        <li>Conference: @_filterModel.Conference.Value</li>
                                    }
                                    @if (_filterModel.FarmType.HasValue)
                                    {
                                        <li>Type: @_filterModel.FarmType.Value</li>
                                    }
                                    @if (_filterModel.MinSize.HasValue || _filterModel.MaxSize.HasValue)
                                    {
                                        <li>Size:
                                            @(_filterModel.MinSize.HasValue ? _filterModel.MinSize.Value.ToString("N1") + " ha" : "0 ha")
                                            to
                                            @(_filterModel.MaxSize.HasValue ? _filterModel.MaxSize.Value.ToString("N1") + " ha" : "unlimited")
                                        </li>
                                    }
                                    @if (!string.IsNullOrEmpty(_filterModel.DistrictId))
                                    {
                                        var district = _districts.FirstOrDefault(d => d.Id == _filterModel.DistrictId)?.Name ?? "Unknown";
                                        <li>District: @district</li>
                                    }
                                    @if (!string.IsNullOrEmpty(_filterModel.LocalAuthorityId))
                                    {
                                        var localAuthority = _localAuthorities.FirstOrDefault(l => l.Id == _filterModel.LocalAuthorityId)?.Name ?? "Unknown";
                                        <li>Local Authority: @localAuthority</li>
                                    }
                                </ul>
                            </div>
                        }

                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <button type="button" class="btn btn-secondary" @onclick="ResetFilters">Reset Filters
                            </button>
                        </div>
                    </EditForm>
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
    

    <SfSpinner @ref="_spinnerRef" Size="40" Type="SpinnerType.Bootstrap" CssClass="global-spinner"
               Visible="false"></SfSpinner>
</div>

@code {

    // Map elements
    private ElementReference _mapElement;
    private IJSObjectReference? _mapModule;
    private IJSObjectReference? _drawControl;
    private IJSObjectReference? _deleteControl;

    private IJSObjectReference? _mapInstance;
    private const string DELETE_BUTTON_ID = "simple-delete-button";

    // Add a flag to track drawing mode
    private bool _isInDrawingMode = false;

    // Private field to store the .NET object reference
    private DotNetObjectReference<Map> _dotNetRef;

    // UI references
    private Toast _alert;
    private SfSpinner _spinnerRef;

    // Data models
    private List<FarmViewModel> _farms = new();
    private List<FarmViewModel> _filteredFarms = new();
    private FarmViewModel _farm = new FarmViewModel();
    private List<FieldViewModel> _fields = new();
    private List<FieldViewModel> _filteredFields = new();
    private CreateFieldViewModel _fieldEdit = new CreateFieldViewModel();
    private FieldViewModel _field = new FieldViewModel();
    private List<FieldLocationViewModel> _fieldLocations = new();
    private FieldLocationViewModel _fieldLocation = new FieldLocationViewModel();
    private FileViewModel _kml = new();
    private string _currentCrop = string.Empty;
    private bool _isSchoolUser = false;
    private List<FarmViewModel> _managedFarms = new List<FarmViewModel>();
    private string _showAddFarm = "panel-hidden";
    private AddFarmViewModel _newFarm = new AddFarmViewModel();
    private ClaimsPrincipal _user;

    // Filter-related properties
    private bool _isCurrentlyFiltering = false;
    private bool ShowFiltersModal { get; set; } = false;
    private FarmFilterModel _filterModel = new FarmFilterModel();
    private List<FarmViewModel> _allFarms = new(); // Store all farms for filtering
    private List<List<double>> _drawnCoordinates = new List<List<double>>();
    private List<List<double>> _drawnFarmCoordinates = new List<List<double>>();
    private List<List<double>> _drawnSchoolCoordinates = new List<List<double>>();

    // UI state variables
    private bool _showDeleteCoordinateDialog = false;
    private bool _showUploadFieldsDialog = false;
    private bool _showCoordinateForm = false;
    private bool _editingCoordinate = false;
    private bool _loading = true;
    private bool _fieldsLoading = false;
    private bool _loadingKml = false;
    private string _searchTerm = string.Empty;
    private string _fieldSearchTerm = string.Empty;
    private IBrowserFile _loadedKmlFile;

    // Panel visibility state
    private string _showSchools = "";
    private string _showAddSchool = "panel-hidden";
    private string _showSchoolDetails = "panel-hidden";
    private string _showFieldEdit = "panel-hidden";
    private string _showFieldDetails = "panel-hidden";

    // Reference data 
    private ObservableCollection<ProvinceViewModel> _provinces = new();
    private ObservableCollection<DistrictViewModel> _districts = new();
    private ObservableCollection<DistrictViewModel> _allDistricts = new();
    private ObservableCollection<LocalAuthorityViewModel> _localAuthorities = new();
    private ObservableCollection<LocalAuthorityViewModel> _allLocalAuthorities = new();
    private ObservableCollection<WardViewModel> _wards = new();
    private ObservableCollection<WardViewModel> _allWards = new();
    private List<RegionModel> _regions = Enum.GetValues<Region>().Select(x => new RegionModel(x)).ToList();
    private List<TerrainModel> _terrains = Enum.GetValues<Terrain>().Select(x => new TerrainModel(x)).ToList();
    private List<ConferenceModel> _conferences = Enum.GetValues<Conference>().Select(x => new ConferenceModel(x)).ToList();
    private List<WaterAvailabilityModel> _waterAvailabilities = Enum.GetValues<WaterAvailability>().Select(x => new WaterAvailabilityModel(x)).ToList();
    private List<RoadAccessModel> _roadAccess = Enum.GetValues<RoadAccess>().Select(x => new RoadAccessModel(x)).ToList();
    private List<SoilTypeModel> _soilTypes = Enum.GetValues<SoilType>().Select(x => new SoilTypeModel(x)).ToList();
    private List<FarmTypeModel> _farmTypes = Enum.GetValues<FarmType>().Select(x => new FarmTypeModel(x)).ToList();

    #region Form Methods

    private async Task SaveFarm()
    {
        try
        {
            await ShowSpinner();

            UI.Shared.Models.ApiResponse<FarmViewModel> response;
            bool isNewFarm = string.IsNullOrEmpty(_farm.Id);
            
            if (isNewFarm)
            {
                response = await ApiCall.Add<UI.Shared.Models.ApiResponse<FarmViewModel>, FarmViewModel>(
                    await ApiCall.GetHttpClient(), "farms/createfarm", _farm);
            }
            else
            {
                response = await ApiCall.Update<UI.Shared.Models.ApiResponse<FarmViewModel>, FarmViewModel>(
                    await ApiCall.GetHttpClient(), "farms/updatefarm", _farm.Id, _farm);
            }

            if (response == null)
            {
                _alert.Show("Failed to save school, please try again!", showTitle: true, toastType: ToastType.Danger);
            }
            else if (response.Status == (int)HttpStatusCode.OK)
            {
                string farmId = response.Result?.Id ?? _farm.Id;
                
                // Save farm boundary coordinates for both new and existing farms
                if (_drawnSchoolCoordinates != null && _drawnSchoolCoordinates.Count > 0 && !string.IsNullOrEmpty(farmId))
                {
                    // For existing farms, clear old boundaries first
                    if (!isNewFarm)
                    {
                        await DeleteExistingFarmBoundaries(farmId);
                    }
                    await SaveFarmBoundaryCoordinates(farmId, _drawnSchoolCoordinates, isNewCoordinates: true);
                }
                
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Success);

                // Refresh farm list and select the saved farm
                await LoadFarms();

                if (response.Result != null)
                {
                    _farm = response.Result;
                    await OnFarmSelect(_farm);
                }
            }
            else
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Danger);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error saving farm");
        }
        finally
        {
            await HideSpinner();
        }
    }
    
    async Task SaveNewFarm()
    {
        try
        {
            await ShowSpinner();
        
            var response = await ApiCall.Add<ApiResponse<FarmViewModel>, AddFarmViewModel>(
                await ApiCall.GetHttpClient(),
                $"farms/AddFarmToSchool/school/{_farm.Id}/add-farm",
                _newFarm);
            
            if (response?.Status == (int)HttpStatusCode.OK && response.Result != null)
            {
                string farmId = response.Result.Id;
                
                // If we have drawn farm boundary coordinates, save them as locations
                if (_drawnFarmCoordinates != null && _drawnFarmCoordinates.Count > 0)
                {
                    await SaveFarmBoundaryCoordinates(farmId, _drawnFarmCoordinates, isNewCoordinates: true);
                }
                
                _alert.Show("Farm added successfully!", showTitle: true, toastType: ToastType.Success);
                CancelAddFarm();
            
                // Reload farm details to show new farm
                await OnFarmSelect(_farm);
            }
            else
            {
                _alert.Show(response?.Title ?? "Failed to add farm", showTitle: true, toastType: ToastType.Danger);
            }
        }
        finally
        {
            await HideSpinner();
        }
    }

    private async Task SaveField()
    {
        try
        {
            await ShowSpinner();

            // Make sure the field is assigned to the current farm
            _fieldEdit.FarmId = _farm.Id;

            UI.Shared.Models.ApiResponse<FieldViewModel> response;
            bool isNewField = string.IsNullOrEmpty(_fieldEdit.Id);

            if (isNewField)
            {
                // New field - proceed with save
                response = await ApiCall.Add<UI.Shared.Models.ApiResponse<FieldViewModel>, CreateFieldViewModel>(
                    await ApiCall.GetHttpClient(), "fields/createfield", _fieldEdit);

                // If we have drawn coordinates and the save was successful, add them as locations
                if (response?.Status == (int)HttpStatusCode.OK && response.Result != null && _drawnCoordinates != null && _drawnCoordinates.Count > 0)
                {
                    string fieldId = response.Result.Id;
                    await SaveFieldCoordinates(fieldId, _drawnCoordinates, isNewCoordinates: true);
                }
            }
            else
            {
                // Update existing field
                var updateField = new FieldViewModel
                {
                    Id = _fieldEdit.Id,
                    Name = _fieldEdit.Name,
                    Description = _fieldEdit.Description,
                    Size = _fieldEdit.Size,
                    SoilType = _fieldEdit.SoilType,
                    Irrigation = _fieldEdit.Irrigation,
                    FarmId = _fieldEdit.FarmId
                };

                response = await ApiCall.Update<UI.Shared.Models.ApiResponse<FieldViewModel>, FieldViewModel>(
                    await ApiCall.GetHttpClient(), "fields/updatefield", updateField.Id, updateField);

                // For existing fields, handle coordinate updates if they were modified
                if (response?.Status == (int)HttpStatusCode.OK && _drawnCoordinates != null && _drawnCoordinates.Count > 0)
                {
                    await SaveFieldCoordinates(_fieldEdit.Id, _drawnCoordinates, isNewCoordinates: false);
                }
            }

            if (response == null)
            {
                _alert.Show("Failed to save field, please try again!", showTitle: true, toastType: ToastType.Danger);
            }
            else if (response.Status == (int)HttpStatusCode.OK)
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Success);

                // Reset drawn coordinates
                _drawnCoordinates = new List<List<double>>();

                // Clear any drawings on the map using default controls
                if (_drawControl != null)
                {
                    await _mapModule.InvokeVoidAsync("clearAllDrawings", _drawControl);
                }

                // Refresh field list
                await LoadFields(_farm.Id);

                // Go back to school details view showing updated fields
                CancelFieldEdit();
            }
            else
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Danger);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error saving field");
        }
        finally
        {
            await HideSpinner();
        }
    }

    private async Task SaveFieldLocation()
    {
        try
        {
            await ShowSpinner();

            // Assign field ID
            _fieldLocation.FieldId = _field.Id;

            UI.Shared.Models.ApiResponse<FieldLocationViewModel> response;

            if (string.IsNullOrEmpty(_fieldLocation.Id))
            {
                // Create new coordinate
                response = await ApiCall.Add<UI.Shared.Models.ApiResponse<FieldLocationViewModel>, FieldLocationViewModel>(
                    await ApiCall.GetHttpClient(), "fieldLocations/createfieldLocation", _fieldLocation);
            }
            else
            {
                // Update existing coordinate
                response = await ApiCall.Update<UI.Shared.Models.ApiResponse<FieldLocationViewModel>, FieldLocationViewModel>(
                    await ApiCall.GetHttpClient(), "fieldLocations/updatefieldLocation", _fieldLocation.Id, _fieldLocation);
            }

            if (response == null)
            {
                _alert.Show("Failed to save coordinate, please try again!", showTitle: true, toastType: ToastType.Danger);
            }
            else if (response.Status == (int)HttpStatusCode.OK)
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Success);

                // Refresh field locations
                await LoadFieldLocations(_field.Id);

                // Refresh field boundaries on map
                await UpdateFieldOnMap(_field);

                // Reset form
                ResetCoordinateForm();
            }
            else
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Danger);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error saving field location");
        }
        finally
        {
            await HideSpinner();
        }
    }

    private async Task SaveDrawnCoordinates(string fieldId)
    {
        try
        {
            // Convert drawn coordinates to field locations
            foreach (var coord in _drawnCoordinates)
            {
                if (coord.Count >= 2)
                {
                    var location = new FieldLocationViewModel
                    {
                        FieldId = fieldId,
                        Longitude = coord[0],
                        Latitude = coord[1],
                        Altitude = coord.Count > 2 ? coord[2] : 0
                    };

                    // Save each coordinate
                    await ApiCall.Add<UI.Shared.Models.ApiResponse<FieldLocationViewModel>, FieldLocationViewModel>(
                        await ApiCall.GetHttpClient(), "fieldLocations/createfieldLocation", location);
                }
            }

            _alert.Show("Field boundary coordinates saved successfully!", toastType: ToastType.Success);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error saving field boundary: {ex.Message}", toastType: ToastType.Warning);
            Logger.LogError(ex, "Error saving field coordinates");
        }
    }

    // Helper method to save coordinates, handling both new and edited fields
    private async Task SaveFieldCoordinates(string fieldId, List<List<double>> coordinates, bool isNewCoordinates)
    {
        try
        {
            if (!isNewCoordinates)
            {
                // For existing fields, delete old coordinates first
                var existingLocations = await ApiCall.Get<IEnumerable<FieldLocationViewModel>>(
                    await ApiCall.GetHttpClient(), $"fieldLocations/getFieldLocationsByFieldId/{fieldId}");

                if (existingLocations != null && existingLocations.Any())
                {
                    foreach (var location in existingLocations)
                    {
                        // Delete each existing location
                        await ApiCall.Remove<UI.Shared.Models.ApiResponse<string>>(
                            await ApiCall.GetHttpClient(), "fieldlocations/DeleteFieldLocation", location.Id);
                    }

                    Logger.LogInformation($"Deleted {existingLocations.Count()} existing coordinates for field {fieldId}");
                }
            }

            // Now add the new coordinates
            int coordinatesAdded = 0;
            foreach (var coord in coordinates)
            {
                if (coord.Count >= 2)
                {
                    var location = new FieldLocationViewModel
                    {
                        FieldId = fieldId,
                        Longitude = coord[0],
                        Latitude = coord[1],
                        Altitude = coord.Count > 2 ? coord[2] : 0
                    };

                    // Save each coordinate
                    await ApiCall.Add<UI.Shared.Models.ApiResponse<FieldLocationViewModel>, FieldLocationViewModel>(
                        await ApiCall.GetHttpClient(), "fieldLocations/createfieldLocation", location);

                    coordinatesAdded++;
                }
            }

            Logger.LogInformation($"Added {coordinatesAdded} coordinates for field {fieldId}");
            _alert.Show($"Field boundary with {coordinatesAdded} points saved successfully!", toastType: ToastType.Success);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error saving field boundary: {ex.Message}", toastType: ToastType.Warning);
            Logger.LogError(ex, "Error saving field coordinates");
            throw; // Rethrow to handle in calling method
        }
    }

    private async Task SaveKmlFile()
    {
        try
        {
            await ShowSpinner();
            _loadingKml = true;

            if (_loadedKmlFile == null)
            {
                _alert.Show("Please select a KML file first.", showTitle: true, toastType: ToastType.Warning);
                return;
            }

            var ms = new MemoryStream();
            var fileStream = _loadedKmlFile.OpenReadStream();
            await fileStream.CopyToAsync(ms);

            var file = new FileViewModel(ms.ToArray(), farmId: _farm.Id);

            var response = await ApiCall.Add<UI.Shared.Models.ApiResponse<object>, FileViewModel>(
                await ApiCall.GetHttpClient(), "fieldlocations/UploadKmlData", file);

            if (response == null)
            {
                _alert.Show("Failed to import KML data, please try again!", showTitle: true, toastType: ToastType.Danger);
            }
            else if (response.Status == (int)HttpStatusCode.OK)
            {
                _alert.Show("KML data imported successfully", showTitle: true, toastType: ToastType.Success);

                // Close the dialog
                _showUploadFieldsDialog = false;

                // Refresh field list and map
                await OnFarmSelect(_farm);
            }
            else
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Danger);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error importing KML: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error importing KML file");
        }
        finally
        {
            _loadingKml = false;
            await HideSpinner();
        }
    }

    private async Task LoadKmlFiles(InputFileChangeEventArgs e)
    {
        try
        {
            _loadingKml = true;

            var file = e.File;
            if (file != null)
            {
                if (!file.Name.EndsWith(".kml", StringComparison.OrdinalIgnoreCase))
                {
                    _alert.Show("Please select a valid KML file.", showTitle: true, toastType: ToastType.Warning);
                    _loadedKmlFile = null;
                    return;
                }

                _loadedKmlFile = file;

                // You might want to validate KML file here
                // For now we'll just show a success message
                _alert.Show($"File selected: {file.Name}", showTitle: false);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error selecting file: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error selecting KML file");
            _loadedKmlFile = null;
        }
        finally
        {
            _loadingKml = false;
        }
    }

    private async Task DeleteFieldCoordinate()
    {
        try
        {
            await ShowSpinner();

            var response = await ApiCall.Remove<UI.Shared.Models.ApiResponse<string>>(
                await ApiCall.GetHttpClient(), "fieldlocations/DeleteFieldLocation", _fieldLocation.Id);

            if (response == null)
            {
                _alert.Show("Failed to delete coordinate, please try again!", showTitle: true, toastType: ToastType.Danger);
            }
            else if (response.Status == (int)HttpStatusCode.OK)
            {
                _alert.Show("Coordinate deleted successfully", showTitle: true, toastType: ToastType.Success);

                // Remove from local list
                _fieldLocations.Remove(_fieldLocations.First(l => l.Id == _fieldLocation.Id));

                // Reset selection
                _fieldLocation = new FieldLocationViewModel();
                _showDeleteCoordinateDialog = false;

                // Refresh field on map (redraws polygon with updated coordinates)
                await UpdateFieldOnMap(_field);
            }
            else
            {
                _alert.Show(response.Title, showTitle: true, toastType: ToastType.Danger);
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error deleting field coordinate");
        }
        finally
        {
            await HideSpinner();
        }
    }
    
    void ShowAddFarmForm()
    {
        _newFarm = new AddFarmViewModel
        {
            ParentSchoolId = _farm.Id
        };
        
        // Reset drawn coordinates for new farm
        _drawnFarmCoordinates = new List<List<double>>();
        
        // Update UI state to show the add farm form
        _showSchools = "panel-hidden";
        _showAddSchool = "panel-hidden";
        _showSchoolDetails = "panel-hidden";
        _showFieldEdit = "panel-hidden";
        _showFieldDetails = "panel-hidden";
        _showAddFarm = "";
        
        // Clear any existing drawings
        if (_drawControl != null)
        {
            InvokeAsync(async () =>
            {
                await _mapModule.InvokeVoidAsync("clearAllDrawings", _drawControl);
            });
        }
    }
    
    void CancelAddFarm()
    {
        _showAddFarm = "panel-hidden";
        _showSchoolDetails = "";
        
        // Reset drawn farm coordinates
        _drawnFarmCoordinates = new List<List<double>>();
        
        // Clear any drawings on the map using default controls
        if (_drawControl != null)
        {
            InvokeAsync(async () =>
            {
                await _mapModule.InvokeVoidAsync("clearAllDrawings", _drawControl);
            });
        }
    }

    #endregion

    #region Event Handlers

    async Task EnableMapClickForNewFarmLocation()
    {
        if (_mapModule != null && _dotNetRef != null)
        {
            await _mapModule.InvokeVoidAsync("enableLocationPicker", _mapInstance, _dotNetRef, "SetNewFarmLocation");
        }
    }
    
    [JSInvokable]
    public void SetNewFarmLocation(double lat, double lng)
    {
        if (_newFarm != null)
        {
            _newFarm.Latitude = lat;
            _newFarm.Longitude = lng;
            StateHasChanged();
        }
    }
    
    void ClearNewFarmLocation()
    {
        if (_newFarm != null)
        {
            _newFarm.Latitude = 0;
            _newFarm.Longitude = 0;
            StateHasChanged();
        }
    }
    
    async Task CalculateFarmAreaFromBoundary(FarmViewModel farm, List<List<double>> coordinates)
    {
        try
        {
            if (coordinates != null && coordinates.Count >= 3 && _mapModule != null)
            {
                // Calculate area using Turf.js through the JavaScript module
                var area = await _mapModule.InvokeAsync<double>("calculatePolygonArea", coordinates);
                
                // Convert from square meters to hectares
                var hectares = (float)(area / 10000);
                
                Logger.LogInformation($"Calculated area: {area} m² = {hectares:F2} hectares");
                
                // Update the farm size
                farm.Size = hectares;
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating farm area from boundary");
        }
    }
    
    async Task CalculateFarmAreaFromBoundary(AddFarmViewModel farm, List<List<double>> coordinates)
    {
        try
        {
            if (coordinates != null && coordinates.Count >= 3 && _mapModule != null)
            {
                // Calculate area using Turf.js through the JavaScript module
                var area = await _mapModule.InvokeAsync<double>("calculatePolygonArea", coordinates);
                
                // Convert from square meters to hectares
                var hectares = (float)(area / 10000);
                
                Logger.LogInformation($"Calculated area: {area} m² = {hectares:F2} hectares");
                
                // Update the farm size
                farm.Size = hectares;
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating farm area from boundary");
        }
    }
    
    async Task DeleteExistingFarmBoundaries(string farmId)
    {
        try
        {
            // Get existing farm locations
            var existingLocations = await ApiCall.Get<IEnumerable<FarmLocationViewModel>>(
                await ApiCall.GetHttpClient(), $"farmlocations/getfarmlocationsbyfarmid/{farmId}");
            
            if (existingLocations != null && existingLocations.Any())
            {
                // Delete each existing location
                foreach (var location in existingLocations)
                {
                    if (!string.IsNullOrEmpty(location.Id))
                    {
                        var deleteResponse = await ApiCall.Remove<ApiResponse>(
                            await ApiCall.GetHttpClient(), $"farmlocations/deleteFarmLocation", location.Id);
                        
                        if (deleteResponse?.Status != (int)HttpStatusCode.OK)
                        {
                            Logger.LogWarning($"Failed to delete farm location {location.Id}: {deleteResponse?.Title}");
                        }
                    }
                }
                Logger.LogInformation($"Deleted {existingLocations.Count()} existing farm boundary points");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting existing farm boundaries");
            // Continue with saving new boundaries even if deletion fails
        }
    }
    
    async Task SaveFarmBoundaryCoordinates(string farmId, List<List<double>> coordinates, bool isNewCoordinates)
    {
        try
        {
            // Convert drawn coordinates to farm locations
            foreach (var coord in coordinates)
            {
                if (coord.Count >= 2)
                {
                    var farmLocation = new FarmLocationViewModel
                    {
                        FarmId = farmId,
                        Longitude = coord[0],
                        Latitude = coord[1],
                        Altitude = coord.Count > 2 ? coord[2] : 0,
                        Label = "Boundary Point"
                    };

                    var response = await ApiCall.Add<ApiResponse<FarmLocationViewModel>, FarmLocationViewModel>(
                        await ApiCall.GetHttpClient(), "farmlocations/createfarmlocation", farmLocation);

                    if (response?.Status != (int)HttpStatusCode.OK)
                    {
                        Logger.LogError($"Failed to save farm boundary coordinate: {response?.Title}");
                    }
                }
            }

            Logger.LogInformation($"Successfully saved {coordinates.Count} farm boundary coordinates");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving farm boundary coordinates");
            _alert.Show("Warning: Farm boundary coordinates could not be saved", toastType: ToastType.Warning);
        }
    }

    // Farm selection handler
    async Task OnFarmSelect(FarmViewModel farm)
    {
        try
        {
            await ShowSpinner();
            _farm = farm;
            
            // Check if this is a school
            if (_farm.FarmType == FarmType.School)
            {
                _isSchoolUser = true;
            
                // Load managed farms
                var response = await ApiCall.Get<ApiResponse<List<FarmViewModel>>>(
                    await ApiCall.GetHttpClient(), 
                    $"farms/GetSchoolFarms/school/{_farm.Id}/farms");
                
                if (response?.Status == (int)HttpStatusCode.OK && response?.Result != null)
                {
                    _managedFarms = response.Result;
                }
            }

            // Get detailed farm information with field data
            var farmMap = await ApiCall.Get<FarmMapViewModel>(
                await ApiCall.GetHttpClient(), $"farms/GetFarmDetails/{_farm.Id}");

            // Update UI state
            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";

            // Load fields for this farm
            await LoadFields(_farm.Id);

            // Ensure UI state is updated before map operations
            StateHasChanged();
            await Task.Delay(150);

            if (_mapModule is not null)
            {
                // First clear the map completely
                await _mapModule.InvokeVoidAsync("clearMap", _mapInstance).AsTask();

                Logger.LogInformation("Hatisati ta drawer farm racho");

                // Draw the farm boundary if available
                if (farmMap.IsPolygon)
                {
                    await _mapModule.InvokeVoidAsync("drawPolygon",
                        _mapInstance,
                        farm.Id,
                        farmMap.FarmPolygon,
                        false, // Not a field
                        farm.Name,
                        null, // No crop data for farm
                        false // Clear existing layers
                    ).AsTask();
                }

                // Draw all fields INSIDE the farm boundary
                foreach (var field in farmMap.Fields)
                {
                    await DrawFieldWithCropData(field);
                }

                // Always zoom in closely on the selected school
                int zoomLevel = 14; // Higher zoom level for better detail

                // If we have a farm boundary with meaningful coordinates, center on it
                if (farmMap.IsPolygon && farmMap.FarmCoordinates.Count > 0)
                {
                    // Calculate center of the farm polygon
                    double avgLat = farmMap.FarmCoordinates.Average(c => c[1]);
                    double avgLng = farmMap.FarmCoordinates.Average(c => c[0]);

                    // Center map with closer zoom
                    await _mapModule.InvokeVoidAsync("setMapCenter",
                        _mapInstance,
                        avgLat,
                        avgLng,
                        zoomLevel
                    ).AsTask();
                }
                // Otherwise, fall back to farm coordinates
                else if (farmMap.Latitude != 0 && farmMap.Longitude != 0)
                {
                    // Center the map on the farm coordinates with closer zoom
                    await _mapModule.InvokeVoidAsync("setMapCenter",
                        _mapInstance,
                        farmMap.Latitude,
                        farmMap.Longitude,
                        zoomLevel
                    ).AsTask();
                }
            }
            
            // Draw managed farms on the map
            if (_isSchoolUser && _managedFarms.Any())
            {
                foreach (var managedFarm in _managedFarms)
                {
                    await DrawFarmOnMap(managedFarm, true);
                }
            }
        }
        catch (Exception ex)
        {
            _alert.Show($"Error displaying farm: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error selecting farm");
        }
        finally
        {
            await HideSpinner();
        }
    }

    // Field selection handler
    async Task OnFieldSelect(FieldViewModel field)
    {
        try
        {
            await ShowSpinner();
            _field = field;

            // Load field locations
            await LoadFieldLocations(field.Id);

            // Check for current crop data
            var fieldCrops = await ApiCall.Get<IEnumerable<FieldCropViewModel>>(
                await ApiCall.GetHttpClient(), $"fieldcrops/getfieldfieldcrops/{field.Id}");

            var currentCrop = fieldCrops?.OrderByDescending(c => c.PlantedDate).FirstOrDefault();
            if (currentCrop != null)
            {
                _currentCrop = $"{currentCrop.Crop} ({currentCrop.Size} ha, {(currentCrop.Irrigation ? "Irrigated" : "Non-irrigated")})";
                if (currentCrop.PlantedDate.HasValue)
                {
                    _currentCrop += $" - Planted: {currentCrop.PlantedDate.Value:d}";
                }
            }
            else
            {
                _currentCrop = string.Empty;
            }

            // Update UI state
            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "";
            _showAddFarm = "panel-hidden";

            // Ensure UI state is updated before map operations
            StateHasChanged();
            await Task.Delay(150);

            // Focus map on this field
            await UpdateFieldOnMap(field);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error displaying field: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error selecting field");
        }
        finally
        {
            await HideSpinner();
        }
    }

    // Coordinate selection handler
    void OnCoordinateSelect(FieldLocationViewModel coordinate)
    {
        _fieldLocation = coordinate;
        _showDeleteCoordinateDialog = true;
    }

    // Dropdown event handlers
    public void ProvinceChangeHandler(ChangeEventArgs<string, ProvinceViewModel> args)
    {
        var districts = _allDistricts.Where(d => d.ProvinceId == args.Value).OrderBy(w => w.Name).ToList();
        _districts.Clear();

        try
        {
            foreach (var item in districts)
            {
                _districts.Add(item);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in ProvinceChangeHandler");
        }

        StateHasChanged();
    }

    public void DistrictChangeHandler(ChangeEventArgs<string, DistrictViewModel> args)
    {
        var localAuthorities = _allLocalAuthorities.Where(l => l.DistrictId == args.Value).OrderBy(w => w.Name).ToList();
        var wards = _allWards.Where(w => w.DistrictId == args.Value).OrderBy(w => w.Name).ToList();

        _localAuthorities.Clear();
        _wards.Clear();

        try
        {
            foreach (var item in localAuthorities)
            {
                _localAuthorities.Add(item);
            }

            foreach (var item in wards)
            {
                _wards.Add(item);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in DistrictChangeHandler");
        }

        StateHasChanged();
    }

    public void LocalAuthorityChangeHandler(ChangeEventArgs<string, LocalAuthorityViewModel> args)
    {
        var wards = _allWards.Where(w => w.LocalAuthorityId == args.Value).OrderBy(w => w.Name).ToList();
        _wards.Clear();

        try
        {
            foreach (var item in wards)
            {
                _wards.Add(item);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in LocalAuthorityChangeHandler");
        }

        StateHasChanged();
    }

    // Search filtering
    void ToggleFiltersModal()
    {
        ShowFiltersModal = !ShowFiltersModal;
    }

    // JavaScript-invokable method to toggle the filter modal
    [JSInvokable]
    public void ToggleFilterModal()
    {
        ShowFiltersModal = !ShowFiltersModal;
        StateHasChanged();
    }

    bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(_filterModel.ProvinceId) ||
               _filterModel.Region.HasValue ||
               _filterModel.Conference.HasValue ||
               _filterModel.FarmType.HasValue ||
               _filterModel.MinSize.HasValue ||
               _filterModel.MaxSize.HasValue ||
               !string.IsNullOrEmpty(_filterModel.DistrictId) ||
               !string.IsNullOrEmpty(_filterModel.LocalAuthorityId);
    }

    async Task ApplyFilters()
    {
        // Prevent multiple simultaneous filter operations
        if (_isCurrentlyFiltering) return;

        _isCurrentlyFiltering = true;
        await ShowSpinner();
        try
        {
            // Start with all farms
            _filteredFarms = _allFarms.ToList();

            // Apply Province filter
            if (!string.IsNullOrEmpty(_filterModel.ProvinceId))
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.ProvinceId == _filterModel.ProvinceId)
                    .ToList();
            }

            // Apply Region filter
            if (_filterModel.Region.HasValue)
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.Region == _filterModel.Region.Value)
                    .ToList();
            }

            // Apply Conference filter
            if (_filterModel.Conference.HasValue)
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.Conference == _filterModel.Conference.Value)
                    .ToList();
            }

            // Apply FarmType filter
            if (_filterModel.FarmType.HasValue)
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.FarmType == _filterModel.FarmType.Value)
                    .ToList();
            }

            // Apply Size range filter
            if (_filterModel.MinSize.HasValue)
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.Size >= _filterModel.MinSize.Value)
                    .ToList();
            }

            if (_filterModel.MaxSize.HasValue)
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.Size <= _filterModel.MaxSize.Value)
                    .ToList();
            }

            // Apply District filter
            if (!string.IsNullOrEmpty(_filterModel.DistrictId))
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.DistrictId == _filterModel.DistrictId)
                    .ToList();
            }

            // Apply Local Authority filter
            if (!string.IsNullOrEmpty(_filterModel.LocalAuthorityId))
            {
                _filteredFarms = _filteredFarms
                    .Where(f => f.LocalAuthorityId == _filterModel.LocalAuthorityId)
                    .ToList();
            }

            // Close the modal
            ShowFiltersModal = false;

            // Store the filtered farms in a local variable to ensure we don't lose reference
            var currentFilteredFarms = _filteredFarms.ToList();

            // Now handle map updates with better state tracking
            if (_mapModule != null)
            {
                try
                {
                    // First clear the map completely and wait for completion
                    await _mapModule.InvokeVoidAsync("clearMap", _mapInstance).AsTask();

                    await Task.Delay(100);

                    // Create filtered GeoJSON for map
                    var validFarms = currentFilteredFarms.Where(f => f.Latitude != 0 && f.Longitude != 0).ToList();

                    Logger.LogInformation($"Preparing to show {validFarms.Count} filtered farms/schools on map");

                    if (validFarms.Any())
                    {
                        var featureCollection = new
                        {
                            type = "FeatureCollection",
                            crs = new
                            {
                                type = "name",
                                properties = new
                                {
                                    name = "urn:ogc:def:crs:OGC:1.3:CRS84"
                                }
                            },
                            features = validFarms.Select(f => new
                            {
                                type = "Feature",
                                properties = new
                                {
                                    id = f.Id,
                                    name = f.Name,
                                    size = f.Size,
                                    address = f.Address
                                },
                                geometry = new
                                {
                                    type = "Point",
                                    coordinates = new[] { f.Longitude, f.Latitude, f.Elevation }
                                }
                            }).ToArray()
                        };

                        // Load the clusters and WAIT for it to complete
                        Logger.LogInformation("Loading clusters on map with filtered data...");
                        await _mapModule.InvokeVoidAsync("loadFarms", _mapInstance, featureCollection).AsTask();

                        // IMPORTANT: Add a short delay to ensure the map has time to complete cluster rendering
                        await Task.Delay(100);

                        // Now adjust the zoom AFTER clusters are loaded
                        if (validFarms.Count > 1)
                        {
                            // Set zoom level based on number of farms
                            int zoomLevel = validFarms.Count > 0 ? 7 :
                                validFarms.Count > 10 ? 8 :
                                validFarms.Count > 5 ? 9 : 10;

                            double avgLat = validFarms.Average(f => f.Latitude);
                            double avgLng = validFarms.Average(f => f.Longitude);

                            Logger.LogInformation($"Setting map center to {avgLat}, {avgLng} with zoom {zoomLevel}");
                            await _mapModule.InvokeVoidAsync("setMapCenter",
                                _mapInstance,
                                avgLat,
                                avgLng,
                                zoomLevel).AsTask();
                        }
                        else if (validFarms.Count == 1)
                        {
                            Logger.LogInformation($"Zooming to single farm at {validFarms[0].Latitude}, {validFarms[0].Longitude}");
                            await _mapModule.InvokeVoidAsync("setMapCenter",
                                _mapInstance,
                                validFarms[0].Latitude,
                                validFarms[0].Longitude,
                                14).AsTask();
                        }
                    }
                    else
                    {
                        Logger.LogWarning("No valid farms to display after filtering");
                        // Default view for Zimbabwe if no valid farms
                        await _mapModule.InvokeVoidAsync("setMapCenter",
                            _mapInstance,
                            -17.824858,
                            31.053028,
                            7).AsTask();
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error updating map after filtering");
                    _alert.Show("Error updating map: " + ex.Message, showTitle: true, toastType: ToastType.Warning);
                }
            }

            // Filter applied success message
            _alert.Show($"Filtered to {_filteredFarms.Count} schools matching criteria", showTitle: true, toastType: ToastType.Success);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error applying filters: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error applying filters");
        }
        finally
        {
            await HideSpinner();
            _isCurrentlyFiltering = false; // Reset the filter operation state
        }
    }

    // Update the ResetFilters method in Map.razor
    async Task ResetFilters()
    {
        await ShowSpinner();
        try
        {
            // Reset filter model
            _filterModel = new FarmFilterModel();

            // Reset filtered farms to all farms  
            _filteredFarms = _allFarms.ToList();

            // Reset map
            if (_mapModule != null)
            {
                await _mapModule.InvokeVoidAsync("clearMap", _mapInstance).AsTask();
                await Task.Delay(100);
                await LoadClusters();
            }

            ShowFiltersModal = false;
            _alert.Show("Filters reset successfully", showTitle: true, toastType: ToastType.Info);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error resetting filters: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error resetting filters");
        }
        finally
        {
            await HideSpinner();
        }
    }

    void FilterFarms()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filteredFarms = _allFarms.ToList();
        }
        else
        {
            _filteredFarms = _allFarms
                .Where(f => f.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                            (f.Address?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }

        StateHasChanged();
    }

    void ClearSearch()
    {
        _searchTerm = string.Empty;
        FilterFarms();
    }

    void FilterFields()
    {
        if (string.IsNullOrWhiteSpace(_fieldSearchTerm))
        {
            _filteredFields = _fields.ToList();
        }
        else
        {
            _filteredFields = _fields
                .Where(f => f.Name.Contains(_fieldSearchTerm, StringComparison.OrdinalIgnoreCase) ||
                            (f.Description?.Contains(_fieldSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }

        StateHasChanged();
    }

    void ClearFieldSearch()
    {
        _fieldSearchTerm = string.Empty;
        FilterFields();
    }

    #endregion

    #region Map Operations

    private async Task DrawFieldWithCropData(FieldViewModel field)
    {
        try
        {
            if (_mapModule == null) return;

            // Get crop data for this field
            var fieldCrops = await ApiCall.Get<IEnumerable<FieldCropViewModel>>(
                await ApiCall.GetHttpClient(), $"fieldcrops/getfieldfieldcrops/{field.Id}");

            var currentCrop = fieldCrops?.OrderByDescending(c => c.PlantedDate).FirstOrDefault();

            // Create crop data object if a crop exists
            object cropDataObj = null;
            if (currentCrop != null)
            {
                cropDataObj = new
                {
                    crop = currentCrop.Crop,
                    plantedDate = currentCrop.PlantedDate,
                    harvestDate = currentCrop.HarvestDate,
                    size = currentCrop.Size,
                    irrigation = currentCrop.Irrigation
                };
            }

            // Draw field with isField=true but clearExisting=false to maintain other layers
            await _mapModule.InvokeVoidAsync("drawPolygon",
                _mapInstance,
                field.Id,
                field.Coordinates,
                true, // This is a field
                field.Name,
                cropDataObj,
                false // Don't clear existing layers (keep farm boundary)
            ).AsTask();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error drawing field with crop data");
        }
    }

    private async Task UpdateFieldOnMap(FieldViewModel field)
    {
        try
        {
            if (_mapModule == null) return;

            // This is similar to OnFieldSelect but focused on map operations

            // First draw the farm boundary (to establish the context)
            var farmMap = await ApiCall.Get<FarmMapViewModel>(
                await ApiCall.GetHttpClient(), $"farms/GetFarmDetails/{_farm.Id}");

            // Clear the map and draw farm boundary
            if (farmMap.IsPolygon)
            {
                await _mapModule.InvokeVoidAsync("drawPolygon",
                    _mapInstance,
                    _farm.Id,
                    farmMap.FarmPolygon,
                    false, // Not a field
                    _farm.Name,
                    null, // No crop data
                    true // Clear existing layers before drawing
                ).AsTask();
            }

            // Get crop data for this field
            var fieldCrops = await ApiCall.Get<IEnumerable<FieldCropViewModel>>(
                await ApiCall.GetHttpClient(), $"fieldcrops/getfieldfieldcrops/{field.Id}");

            var currentCrop = fieldCrops?.OrderByDescending(c => c.PlantedDate).FirstOrDefault();

            // Create crop data object if a crop exists
            object cropDataObj = null;
            if (currentCrop != null)
            {
                cropDataObj = new
                {
                    crop = currentCrop.Crop,
                    plantedDate = currentCrop.PlantedDate,
                    harvestDate = currentCrop.HarvestDate,
                    size = currentCrop.Size,
                    irrigation = currentCrop.Irrigation
                };
            }

            // Draw this field with highlight (above the farm boundary)
            await _mapModule.InvokeVoidAsync("drawPolygon",
                _mapInstance,
                field.Id,
                field.Coordinates,
                true, // This is a field
                field.Name,
                cropDataObj,
                false // Don't clear farm boundary
            ).AsTask();

            // Center map on field's average coordinates if available
            if (field.Locations.Any())
            {
                double avgLat = field.Locations.Average(l => l.Latitude);
                double avgLng = field.Locations.Average(l => l.Longitude);

                await _mapModule.InvokeVoidAsync("setMapCenter", _mapInstance, avgLat, avgLng, 16).AsTask();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating field on map");
        }
    }

    private async Task HighlightField(FieldViewModel field)
    {
        try
        {
            if (_mapModule != null && _mapInstance != null)
            {
                // Call JavaScript function to highlight this field
                await _mapModule.InvokeVoidAsync("highlightFieldOnMap", _mapInstance, field.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error highlighting field {field.Id}");
        }
    }

    private async Task UnhighlightField(FieldViewModel field)
    {
        try
        {
            if (_mapModule != null && _mapInstance != null)
            {
                // Call JavaScript function to unhighlight this field
                await _mapModule.InvokeVoidAsync("unhighlightFieldOnMap", _mapInstance, field.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error unhighlighting field {field.Id}");
        }
    }
    
    async Task DrawFarmOnMap(FarmViewModel farm, bool isManagedFarm = false)
    {
        if (_mapModule != null && farm.Latitude != 0 && farm.Longitude != 0)
        {
            // Draw farm marker with different color for managed farms
            var color = isManagedFarm ? "#FF6B6B" : "#4ECDC4"; // Red for farms, teal for schools
        
            await _mapModule.InvokeVoidAsync("addMarker",
                _mapInstance,
                farm.Id,
                farm.Latitude,
                farm.Longitude,
                farm.Name,
                color,
                isManagedFarm ? "farm" : "school"
            );
        }
    }

    [JSInvokable]
    public void SetDrawingMode(bool isDrawing)
    {
        _isInDrawingMode = isDrawing;
        StateHasChanged();
    }
    
    [JSInvokable]
    public void SetFarmLocation(double lat, double lng)
    {
        _newFarm.Latitude = lat;
        _newFarm.Longitude = lng;
        StateHasChanged();
    }

    async Task EnableMapClickForLocation()
    {
        if (_mapModule != null && _dotNetRef != null)
        {
            await _mapModule.InvokeVoidAsync("enableLocationPicker", _mapInstance, _dotNetRef, "SetFarmLocation");
        }
    }
    
    [JSInvokable]
    public void SetEditFarmLocation(double lat, double lng)
    {
        if (_farm != null)
        {
            _farm.Latitude = lat;
            _farm.Longitude = lng;
            StateHasChanged();
        }
    }
    
    async Task EnableMapClickForEditLocation()
    {
        if (_mapModule != null && _dotNetRef != null)
        {
            await _mapModule.InvokeVoidAsync("enableLocationPicker", _mapInstance, _dotNetRef, "SetEditFarmLocation");
        }
    }

    [JSInvokable]
    public async Task OnPolygonDrawn(List<List<double>> coordinates)
    {
        try
        {
            // Make sure we're not in drawing mode anymore
            _isInDrawingMode = false;

            // Debug logging to check what we're receiving
            Logger.LogInformation($"Received coordinates: {coordinates?.Count ?? 0} points");

            if (coordinates != null && coordinates.Count > 0)
            {
                // Determine what context we're drawing in and store coordinates accordingly
                if (_showFieldEdit != "panel-hidden")
                {
                    // Drawing field boundary
                    bool isExistingField = !string.IsNullOrEmpty(_fieldEdit.Id);
                    _drawnCoordinates = coordinates;
                    Logger.LogInformation($"Stored coordinates for field boundary: {coordinates.Count} points");
                    
                    // Log a few coordinates for debugging if we have them
                    if (coordinates.Count > 0)
                    {
                        // Log first coordinate point
                        Logger.LogInformation($"First point: [{string.Join(", ", coordinates[0])}]");

                        // Log last coordinate point if we have multiple
                        if (coordinates.Count > 1)
                        {
                            Logger.LogInformation($"Last point: [{string.Join(", ", coordinates[coordinates.Count - 1])}]");
                        }
                    }

                    // Different messaging based on whether this is a new field or editing an existing one
                    if (isExistingField)
                    {
                        _alert.Show($"Field boundary updated with {coordinates.Count} points!", toastType: ToastType.Success);
                    }
                    else
                    {
                        _alert.Show($"Field boundary drawn successfully with {coordinates.Count} points!", toastType: ToastType.Success);
                    }
                }
                else if (_showAddFarm != "panel-hidden")
                {
                    // Drawing new farm boundary
                    _drawnFarmCoordinates = coordinates;
                    Logger.LogInformation($"Stored coordinates for new farm boundary: {coordinates.Count} points");
                    
                    // Auto-calculate farm size from boundary if possible
                    await CalculateFarmAreaFromBoundary(_newFarm, coordinates);
                    
                    _alert.Show($"Farm boundary drawn successfully with {coordinates.Count} points!", toastType: ToastType.Success);
                }
                else if (_showAddSchool != "panel-hidden")
                {
                    // Drawing school/farm boundary (edit mode)
                    _drawnSchoolCoordinates = coordinates;
                    Logger.LogInformation($"Stored coordinates for school/farm boundary: {coordinates.Count} points");
                    
                    // Auto-calculate area from boundary if possible
                    await CalculateFarmAreaFromBoundary(_farm, coordinates);
                    
                    _alert.Show($"School/farm boundary drawn successfully with {coordinates.Count} points!", toastType: ToastType.Success);
                }

                // Log a few coordinates for debugging if we have them
                if (coordinates.Count > 0)
                {
                    // Log first coordinate point
                    Logger.LogInformation($"First point: [{string.Join(", ", coordinates[0])}]");

                    // Log last coordinate point if we have multiple
                    if (coordinates.Count > 1)
                    {
                        Logger.LogInformation($"Last point: [{string.Join(", ", coordinates[coordinates.Count - 1])}]");
                    }
                }

                // Force UI refresh
                StateHasChanged();
            }
            else
            {
                Logger.LogWarning("Received empty or null coordinates array");
                _alert.Show("No valid coordinates received for field boundary", toastType: ToastType.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error processing drawn polygon: {Message}", ex.Message);
            _alert.Show("Error processing drawn boundary", toastType: ToastType.Danger);
        }
    }

    [JSInvokable]
    public Task OnDrawingDeleted()
    {
        try
        {
            Logger.LogInformation("OnDrawingDeleted invoked from JavaScript");

            // Determine what context we're deleting from and reset coordinates accordingly
            if (_showFieldEdit != "panel-hidden")
            {
                // Deleting field boundary
                _drawnCoordinates = new List<List<double>>();
                
                // Reset the field size if in edit mode
                if (!string.IsNullOrEmpty(_fieldEdit.Id))
                {
                    _fieldEdit.Size = 0;
                }
                
                _alert.Show("Field boundary drawing deleted", toastType: ToastType.Info);
            }
            else if (_showAddFarm != "panel-hidden")
            {
                // Deleting new farm boundary
                _drawnFarmCoordinates = new List<List<double>>();
                
                // Reset the farm size
                _newFarm.Size = 0;
                
                _alert.Show("Farm boundary drawing deleted", toastType: ToastType.Info);
            }
            else if (_showAddSchool != "panel-hidden")
            {
                // Deleting school/farm boundary (edit mode)
                _drawnSchoolCoordinates = new List<List<double>>();
                
                // Reset the farm size
                _farm.Size = 0;
                
                _alert.Show($"{(_farm.FarmType == Hurudza.Data.Enums.Enums.FarmType.School ? "School" : "Farm")} boundary drawing deleted", toastType: ToastType.Info);
            }

            // Force UI refresh
            StateHasChanged();
            return Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling drawing deletion");
            return Task.CompletedTask;
        }
    }

    private async Task InitializeDrawingControls()
    {
        if (_mapModule != null && _mapInstance != null)
        {
            // Initialize drawing controls with custom JS file
            _drawControl = await _mapModule.InvokeAsync<IJSObjectReference>(
                "initializeDrawControls", _mapInstance);

            if (_drawControl != null)
            {
                // Update JavaScript to handle drawing mode properly
                await _mapModule.InvokeVoidAsync("setupDrawingMode", _mapInstance, _drawControl, _dotNetRef);
            }
        }
    }

    // Method to handle field size updates from Turf.js calculations
    [JSInvokable]
    public void UpdateFieldSize(double areaInHectares)
    {
        try
        {
            // Round to 2 decimal places for better display
            float roundedArea = (float)Math.Round(areaInHectares, 2);

            // Determine if this is an initial calculation or a user-initiated drawing update
            bool isInitialCalculation = _fieldEdit.Size < 0.01 && roundedArea > 0;

            Logger.LogInformation($"Updating field size to {roundedArea} hectares (initial: {isInitialCalculation})");

            // Update the field size property with the calculated area
            _fieldEdit.Size = roundedArea;

            // Only show toast notification for user-initiated calculations
            // or significant changes for initial calculations
            if (!isInitialCalculation || _field.Size == 0 ||
                Math.Abs((_field.Size - roundedArea) / Math.Max(_field.Size, 0.1f)) > 0.1)
            {
                // Show toast notification about the area calculation
                string message = isInitialCalculation
                    ? $"Field size calculated from boundary: {roundedArea} hectares"
                    : $"Field size updated: {roundedArea} hectares";

                _alert.Show(message, title: "Area Calculation", toastType: ToastType.Info);
            }

            // Force UI refresh
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating field size: {Message}", ex.Message);
            _alert.Show("Error updating field size", toastType: ToastType.Danger);
        }
    }

    async Task ClearCurrentDrawing()
    {
        try
        {
            if (_drawControl != null)
            {
                if (_deleteControl != null)
                {
                    await _mapModule.InvokeVoidAsync("clearDrawnPolygons", _drawControl, _deleteControl);
                }
                else
                {
                    await _mapModule.InvokeVoidAsync("clearDrawnPolygons", _drawControl);
                }

                // Reset the drawn coordinates
                _drawnCoordinates = new List<List<double>>();

                // Update the field size to zero since drawing is cleared
                _fieldEdit.Size = 0;

                // Show notification
                _alert.Show("Field boundary drawing cleared", toastType: ToastType.Info);

                // Force UI refresh
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error clearing current drawing");
            _alert.Show("Failed to clear drawing: " + ex.Message, toastType: ToastType.Danger);
        }
    }

    #endregion

    #region Navigation Functions

    // Panel control methods
    void ToggleSchools()
    {
        if (_showAddSchool == "panel-hidden")
        {
            // Switch to Add School view
            _showSchools = "panel-hidden";
            _showAddSchool = "";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";

            // Reset farm model if adding new farm
            if (_farm != null && !string.IsNullOrEmpty(_farm.Id))
            {
                // Keep existing farm data for editing
            }
            else
            {
                _farm = new FarmViewModel();
            }
        }
        else
        {
            // Switch to Schools List view
            _showSchools = "";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";
        }
    }

    async Task GoBackToList()
    {
        try
        {
            await ShowSpinner();
            
            // Reset the current farm
            _farm = new FarmViewModel();
            
            // Update UI state
            _showSchools = "";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";
            
            // Reset filtered farms to all farms to ensure clusters show all accessible farms
            _filteredFarms = _allFarms.ToList();
            
            // Ensure UI state is updated
            StateHasChanged();

            if (_mapModule != null && _mapInstance != null)
            {
                // Check if we have valid farms to display
                var hasValidFarms = _filteredFarms.Any(f => f.Latitude != 0 && f.Longitude != 0);
                
                if (hasValidFarms)
                {
                    Logger.LogInformation($"Reloading clusters for {_filteredFarms.Count} farms when returning to list");
                    
                    // Load clusters fresh - LoadClusters will handle clearing old clusters properly
                    await LoadClusters();
                    
                    // Reset the map view to Zimbabwe's center with appropriate zoom for clusters
                    // Zimbabwe's approximate center: -19.0154° S, 29.1549° E
                    await _mapModule.InvokeVoidAsync("setMapCenter", _mapInstance, -19.0154, 29.1549, 7).AsTask();
                    
                    Logger.LogInformation("Successfully reloaded clusters and centered map");
                }
                else
                {
                    Logger.LogInformation("No valid farms to show clusters for");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error navigating back to farms list");
            _alert.Show($"Error returning to list: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
        }
        finally
        {
            await HideSpinner();
        }
    }

    async Task GoBackToSchool()
    {
        try
        {
            await ShowSpinner();
            Logger.LogInformation("Navigating back to school details from field view");

            // Update UI state first
            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";

            // Ensure UI state is updated before map operations
            StateHasChanged();
            await Task.Delay(100);

            // Reload the farm and all its fields on the map
            if (_farm != null && !string.IsNullOrEmpty(_farm.Id))
            {
                // Get detailed farm information with field data
                var farmMap = await ApiCall.Get<FarmMapViewModel>(
                    await ApiCall.GetHttpClient(), $"farms/GetFarmDetails/{_farm.Id}");

                if (_mapModule is not null)
                {
                    // First clear the map completely
                    await _mapModule.InvokeVoidAsync("clearMap", _mapInstance).AsTask();
                    await Task.Delay(100);

                    // Draw the farm boundary if available
                    if (farmMap.IsPolygon)
                    {
                        await _mapModule.InvokeVoidAsync("drawPolygon",
                            _mapInstance,
                            _farm.Id,
                            farmMap.FarmPolygon,
                            false, // Not a field
                            _farm.Name,
                            null, // No crop data for farm
                            false // Clear existing layers
                        ).AsTask();
                    }

                    // Draw all fields INSIDE the farm boundary
                    foreach (var field in farmMap.Fields)
                    {
                        await DrawFieldWithCropData(field);
                    }

                    // If we have a farm boundary with meaningful coordinates, center on it
                    if (farmMap.IsPolygon && farmMap.FarmCoordinates.Count > 0)
                    {
                        // Calculate center of the farm polygon
                        double avgLat = farmMap.FarmCoordinates.Average(c => c[1]);
                        double avgLng = farmMap.FarmCoordinates.Average(c => c[0]);

                        // Center map with appropriate zoom
                        await _mapModule.InvokeVoidAsync("setMapCenter",
                            _mapInstance,
                            avgLat,
                            avgLng,
                            14 // Zoom level appropriate for viewing a farm
                        ).AsTask();
                    }
                    // Otherwise, fall back to farm coordinates
                    else if (farmMap.Latitude != 0 && farmMap.Longitude != 0)
                    {
                        // Center the map on the farm coordinates
                        await _mapModule.InvokeVoidAsync("setMapCenter",
                            _mapInstance,
                            farmMap.Latitude,
                            farmMap.Longitude,
                            14
                        ).AsTask();
                    }
                }

                Logger.LogInformation($"Re-loaded all field polygons for farm: {_farm.Name}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error navigating back to school details");
            _alert.Show("Error loading school map data", showTitle: true, toastType: ToastType.Warning);
        }
        finally
        {
            await HideSpinner();
        }
    }

    void ShowEdit()
    {
        _showSchools = "panel-hidden";
        _showAddSchool = "";
        _showSchoolDetails = "panel-hidden";
        _showFieldEdit = "panel-hidden";
        _showFieldDetails = "panel-hidden";
    }

    void CancelEdit()
    {
        if (!string.IsNullOrEmpty(_farm.Id))
        {
            // Return to farm details for existing farm
            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";
        }
        else
        {
            // Return to farm list for new farm
            _showSchools = "";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "panel-hidden";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";
        }
    }

    async Task ShowEditField()
    {
        try
        {
            await ShowSpinner();
            Logger.LogInformation("Showing new field form");

            // Initialize a new field with farm ID
            _fieldEdit = new CreateFieldViewModel
            {
                FarmId = _farm.Id
            };

            // Reset drawn coordinates for new field
            _drawnCoordinates = new List<List<double>>();

            // Clear any existing drawings using default MapboxDraw controls
            if (_drawControl != null)
            {
                await _mapModule.InvokeVoidAsync("clearAllDrawings", _drawControl);
            }

            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";

            // The drawing controls are always visible with default MapboxDraw
            // Users can click the polygon tool to start drawing

            Logger.LogInformation("Ready to create new field with default drawing controls");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in ShowEditField: {Message}", ex.Message);
            _alert.Show($"Error: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
        }
        finally
        {
            await HideSpinner();
        }
    }

    async Task EditCurrentField()
    {
        try
        {
            await ShowSpinner();
            Logger.LogInformation("Editing field: {FieldId}", _field.Id);

            // Convert the current field to CreateFieldViewModel for editing
            _fieldEdit = new CreateFieldViewModel
            {
                Id = _field.Id,
                Name = _field.Name,
                Description = _field.Description,
                Size = _field.Size,
                SoilType = _field.SoilType,
                Irrigation = _field.Irrigation,
                FarmId = _field.FarmId
            };

            // Clear any existing drawings
            if (_drawControl != null)
            {
                await _mapModule.InvokeVoidAsync("clearAllDrawings", _drawControl);
            }

            // Load existing coordinates for editing
            if (_field.Locations != null && _field.Locations.Any())
            {
                // Convert field locations to the format needed by the drawing tool
                _drawnCoordinates = _field.Locations
                    .OrderBy(l => l.CreatedDate)
                    .Select(l => new List<double> { l.Longitude, l.Latitude, l.Altitude })
                    .ToList();

                Logger.LogInformation($"Loading {_drawnCoordinates.Count} coordinates for field editing");

                // Add the existing polygon to the drawing tool for editing
                if (_mapModule != null && _drawControl != null && _drawnCoordinates.Count > 0)
                {
                    await _mapModule.InvokeVoidAsync("loadPolygonForEditing",
                        _mapInstance,
                        _drawControl,
                        _drawnCoordinates);
                }
            }

            // Update UI state to show the edit form
            _showSchools = "panel-hidden";
            _showAddSchool = "panel-hidden";
            _showSchoolDetails = "panel-hidden";
            _showFieldEdit = "";
            _showFieldDetails = "panel-hidden";
            _showAddFarm = "panel-hidden";

            // Force UI refresh
            StateHasChanged();
            Logger.LogInformation("Field edit form displayed with default drawing controls");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in EditCurrentField: {Message}", ex.Message);
            _alert.Show($"Error preparing field for editing: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
        }
        finally
        {
            await HideSpinner();
        }
    }

    void CancelFieldEdit()
    {
        // Go back to school details view
        _showSchools = "panel-hidden";
        _showAddSchool = "panel-hidden";
        _showSchoolDetails = "";
        _showFieldEdit = "panel-hidden";
        _showFieldDetails = "panel-hidden";
        _showAddFarm = "panel-hidden";
    }

    async Task AddCoordinate()
    {
        _fieldLocation = new FieldLocationViewModel
        {
            FieldId = _field.Id
        };
        _showCoordinateForm = true;
        _editingCoordinate = false;
    }

    void CancelCoordinateEdit()
    {
        ResetCoordinateForm();
    }

    void ResetCoordinateForm()
    {
        _fieldLocation = new FieldLocationViewModel();
        _showCoordinateForm = false;
        _editingCoordinate = false;
    }

    void CancelDeleteCoordinate()
    {
        _showDeleteCoordinateDialog = false;
        _fieldLocation = new FieldLocationViewModel();
    }

    void ShowUploadFields()
    {
        _showUploadFieldsDialog = true;
        _loadedKmlFile = null;
    }

    void CloseKmlUploadDialog()
    {
        _showUploadFieldsDialog = false;
        _loadedKmlFile = null;
    }
    
    async Task ViewFarmDetails(FarmViewModel farm)
    {
        await OnFarmSelect(farm);
    }

    #endregion

    #region Data Loading Helpers

    private async Task LoadFarms()
    {
        try
        {
            _loading = true;
            StateHasChanged();

            // Use our new endpoint that automatically handles permissions
            var response = await ApiCall.Get<ApiResponse<List<FarmViewModel>>>(
                await ApiCall.GetHttpClient(), "farmusers/getaccessiblefarmdetails");

            if (response?.Status == (int)HttpStatusCode.OK && response.Result != null)
            {
                _farms = response.Result;
                Logger.LogInformation($"Loaded {_farms.Count} accessible schools for current user");
            }
            else
            {
                _farms = new List<FarmViewModel>();
                Logger.LogWarning("Failed to get accessible farms for user");
                _alert.Show("Failed to load schools you have access to", showTitle: true, toastType: ToastType.Warning);
            }

            // IMPORTANT: Store all farms for filtering - this must happen here
            _allFarms = new List<FarmViewModel>(_farms); // Use new list to avoid reference issues

            // Set filtered farms to all farms initially
            _filteredFarms = new List<FarmViewModel>(_farms); // Use new list to avoid reference issues

            Logger.LogInformation($"Loaded {_farms.Count} schools, {_farms.Count(f => f.Latitude != 0 && f.Longitude != 0)} with valid coordinates");
        }
        catch (Exception ex)
        {
            _alert.Show($"Error loading schools: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error loading farms");
            _farms = new List<FarmViewModel>();
            _filteredFarms = new List<FarmViewModel>();
            _allFarms = new List<FarmViewModel>();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadFields(string farmId)
    {
        try
        {
            _fieldsLoading = true;
            StateHasChanged();

            _fields = (await ApiCall.Get<IEnumerable<FieldViewModel>>(
                await ApiCall.GetHttpClient(), $"fields/getfarmfields/{farmId}")).ToList();

            _filteredFields = _fields.ToList();
        }
        catch (Exception ex)
        {
            _alert.Show($"Error loading fields: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error loading fields");
            _fields = new List<FieldViewModel>();
            _filteredFields = new List<FieldViewModel>();
        }
        finally
        {
            _fieldsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadFieldLocations(string fieldId)
    {
        try
        {
            _fieldLocations = (await ApiCall.Get<IEnumerable<FieldLocationViewModel>>(
                await ApiCall.GetHttpClient(), $"fieldLocations/getFieldLocationsByFieldId/{fieldId}")).ToList();
        }
        catch (Exception ex)
        {
            _alert.Show($"Error loading field locations: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error loading field locations");
            _fieldLocations = new List<FieldLocationViewModel>();
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            _provinces = (await ApiCall.Get<ObservableCollection<ProvinceViewModel>>(
                await ApiCall.GetHttpClient(), "provinces/getprovinces"));

            _districts = (await ApiCall.Get<ObservableCollection<DistrictViewModel>>(
                await ApiCall.GetHttpClient(), "districts/getdistricts"));

            _allDistricts = new ObservableCollection<DistrictViewModel>(_districts);

            _localAuthorities = (await ApiCall.Get<ObservableCollection<LocalAuthorityViewModel>>(
                await ApiCall.GetHttpClient(), "localAuthorities/getLocalAuthorities"));

            _allLocalAuthorities = new ObservableCollection<LocalAuthorityViewModel>(_localAuthorities);

            _wards = (await ApiCall.Get<ObservableCollection<WardViewModel>>(
                await ApiCall.GetHttpClient(), "wards/getWards"));

            _allWards = new ObservableCollection<WardViewModel>(_wards);
        }
        catch (Exception ex)
        {
            _alert.Show($"Error loading reference data: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error loading reference data");
        }
    }

    private async Task LoadClusters()
    {
        try
        {
            if (_mapModule != null && _mapInstance != null)
            {
                // Make sure we have farm data
                if (_farms == null || !_farms.Any())
                {
                    Logger.LogInformation("No farms loaded yet, loading farms data for clusters");
                    await LoadFarms();
                }

                // Check again after loading
                if (_farms != null && _farms.Any())
                {
                    // Filter out farms with invalid coordinates (0,0 is often a default value)
                    var validFarms = _filteredFarms.Where(f => f.Latitude != 0 && f.Longitude != 0).ToList();

                    if (validFarms.Any())
                    {
                        Logger.LogInformation($"Creating map clusters with {validFarms.Count} accessible schools");

                        // Create the GeoJSON FeatureCollection
                        var featureCollection = new
                        {
                            type = "FeatureCollection",
                            crs = new
                            {
                                type = "name",
                                properties = new
                                {
                                    name = "urn:ogc:def:crs:OGC:1.3:CRS84"
                                }
                            },
                            features = validFarms.Select(f => new
                            {
                                type = "Feature",
                                properties = new
                                {
                                    id = f.Id,
                                    name = f.Name,
                                    size = f.Size,
                                    address = f.Address
                                },
                                geometry = new
                                {
                                    type = "Point",
                                    coordinates = new[] { f.Longitude, f.Latitude, f.Elevation }
                                }
                            }).ToArray()
                        };

                        // Load the clusters onto the map
                        await _mapModule.InvokeVoidAsync("loadFarms", _mapInstance, featureCollection).AsTask();

                        // Set appropriate zoom level based on number of farms
                        if (validFarms.Count > 1)
                        {
                            // Calculate appropriate zoom level: less zoom for more farms
                            int zoomLevel = validFarms.Count > 50 ? 6 :
                                validFarms.Count > 25 ? 7 :
                                validFarms.Count > 10 ? 8 : 9;

                            // Calculate the center point of all farms
                            double avgLat = validFarms.Average(f => f.Latitude);
                            double avgLng = validFarms.Average(f => f.Longitude);

                            // Center map at calculated position with appropriate zoom
                            await _mapModule.InvokeVoidAsync("setMapCenter",
                                _mapInstance,
                                avgLat,
                                avgLng,
                                zoomLevel).AsTask();
                        }
                        else if (validFarms.Count == 1)
                        {
                            // If there's only one farm, zoom in on it
                            await _mapModule.InvokeVoidAsync("setMapCenter",
                                _mapInstance,
                                validFarms[0].Latitude,
                                validFarms[0].Longitude,
                                14).AsTask();
                        }
                        else
                        {
                            // Default view if no valid farms (shouldn't happen but just in case)
                            await _mapModule.InvokeVoidAsync("setMapCenter",
                                _mapInstance,
                                -17.824858,
                                31.053028,
                                7).AsTask();
                        }
                    }
                    else
                    {
                        Logger.LogWarning("No valid farm coordinates found for map clusters");

                        // Set default view for Zimbabwe
                        await _mapModule.InvokeVoidAsync("setMapCenter",
                            _mapInstance,
                            -17.824858,
                            31.053028,
                            7).AsTask();
                    }
                }
                else
                {
                    Logger.LogWarning("No farms data available for map clusters");
                }
            }
            else
            {
                Logger.LogWarning("Map module or instance not initialized for loading clusters");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading map clusters");
            _alert.Show("Failed to load school locations on map", toastType: ToastType.Warning);
        }
    }

    // Helper methods for Spinner
    private async Task ShowSpinner()
    {
        if (_spinnerRef != null)
        {
            await _spinnerRef.ShowAsync();
        }
    }

    private async Task HideSpinner()
    {
        if (_spinnerRef != null)
        {
            await _spinnerRef.HideAsync();
        }
    }

    #endregion

    #region JavaScript Interop Callbacks

    [JSInvokable]
    public async Task OnSchoolSelectedFromMap(string schoolId, string schoolName)
    {
        try
        {
            Logger.LogInformation($"School selected from map: {schoolName} ({schoolId})");
            
            // Find the farm in our current list
            var selectedFarm = _farms.FirstOrDefault(f => f.Id == schoolId);
            if (selectedFarm != null)
            {
                // Use the existing OnFarmSelect method which handles all the logic
                await OnFarmSelect(selectedFarm);
            }
            else
            {
                // If not in current list, fetch the farm details
                Logger.LogInformation($"Farm not in current list, fetching details for {schoolId}");
                var farmResponse = await ApiCall.Get<ApiResponse<FarmViewModel>>(
                    await ApiCall.GetHttpClient(), $"farms/{schoolId}");
                    
                if (farmResponse?.Status == (int)HttpStatusCode.OK && farmResponse?.Result != null)
                {
                    await OnFarmSelect(farmResponse.Result);
                }
                else
                {
                    _alert.Show($"Could not load details for {schoolName}", showTitle: true, toastType: ToastType.Danger);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling school selection from map");
            _alert.Show($"Error opening school details: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
        }
    }

    #endregion

    #region Page Lifecycle Methods

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await ShowSpinner();

            // Load reference data
            await LoadReferenceData();
            
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _user = authState.User;

            // Load farms data
            await LoadFarms();

            // Make sure _allFarms is populated here for filtering
            _allFarms = _farms.ToList();

            // Signal loading complete
            _loading = false;
        }
        catch (Exception ex)
        {
            _alert.Show($"Error initializing: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
            Logger.LogError(ex, "Error in OnInitializedAsync");
        }
        finally
        {
            await HideSpinner();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Logger.LogInformation("Initializing map...");

                // Initialize the map
                _mapModule = await JS.InvokeAsync<IJSObjectReference>("import",
                    "./Pages/Maps/Map.razor.js");

                if (_mapModule is not null)
                {
                    // Create and get map instance
                    _mapInstance = await _mapModule.InvokeAsync<IJSObjectReference>(
                        "addMapToElement", _mapElement);

                    // Create a DotNetObjectReference for JS interop and store it for disposal
                    _dotNetRef = DotNetObjectReference.Create(this);

                    // Make the DotNet reference available globally for popup callbacks
                    await JS.InvokeAsync<object>("eval", "window.setMapDotNetRef = function(ref) { window.mapDotNetRef = ref; }; null;");
                    await JS.InvokeVoidAsync("setMapDotNetRef", _dotNetRef);

                    // Add filter button to map with .NET reference
                    await _mapModule.InvokeVoidAsync("addFilterButton", _mapInstance, _dotNetRef);

                    // Initialize drawing controls - this will add the default MapboxDraw controls
                    _drawControl = await _mapModule.InvokeAsync<IJSObjectReference>(
                        "initializeDrawControls", _mapInstance, _dotNetRef);

                    // Set up drawing event handlers
                    if (_drawControl is not null)
                    {
                        await _mapModule.InvokeVoidAsync(
                            "setupDrawingEvents", _mapInstance, _drawControl, _dotNetRef);

                        Logger.LogInformation("Default drawing controls setup completed");
                    }

                    // Load clusters on the map
                    await LoadClusters();
                }
            }
            catch (Exception ex)
            {
                _alert.Show($"Error initializing map: {ex.Message}", showTitle: true, toastType: ToastType.Danger);
                Logger.LogError(ex, "Error in OnAfterRenderAsync: {Message}", ex.Message);
            }
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        // Dispose the delete control
        if (_deleteControl is not null)
        {
            await _deleteControl.DisposeAsync();
        }

        // Dispose the drawing control
        if (_drawControl is not null)
        {
            await _drawControl.DisposeAsync();
        }

        // Dispose the map instance
        if (_mapInstance is not null)
        {
            await _mapInstance.DisposeAsync();
        }

        // Dispose the map module
        if (_mapModule is not null)
        {
            await _mapModule.DisposeAsync();
        }

        // Dispose the .NET object reference
        _dotNetRef?.Dispose();
    }

    #endregion

    private class SetupResult
    {
        public bool Success { get; set; }
        public string Message { get; set; }
    }

}